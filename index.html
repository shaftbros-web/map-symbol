<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åœ°å›³è¨˜å·4æŠãƒ‰ãƒªãƒ« â€” æ–‡å­—ç‰ˆï¼ˆå…¨å•æ­£è§£ã¾ã§ï¼‰</title>
  <style>
    :root{--bg:#0b0f14;--panel:#0f1520;--ink:#e6edf3;--muted:#9aa4b2;--ok:#22c55e;--ng:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    body{min-height:100dvh;display:flex;flex-direction:column}
    header,footer{background:var(--panel);padding:8px 10px;font-size:14px;text-align:center}
    main{flex:1;display:grid;place-items:center;padding:10px}
    .wrap{width:100%;max-width:560px;display:grid;gap:10px}
    .symbolBox{display:grid;place-items:center;height:clamp(160px,36vh,320px);border:1px solid #1e293b;border-radius:16px;background:linear-gradient(180deg,#0d1625,#0b1220)}
    .symbol{font-size:clamp(72px,14vh,120px);line-height:1}
    .choices{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .choices button{padding:12px;border:none;border-radius:12px;background:#1f2937;color:var(--ink);font-size:16px}
    .choices button.correct{background:#14532d}
    .choices button.wrong{background:#7f1d1d}
    #feedback{color:var(--muted);font-size:12px;min-height:16px}

    /* æ­£èª¤ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå„å•é¡Œï¼‰ */
    #judge{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:50}
    #judge.show{display:grid}
    #judgeMark{font-size:18vh;font-weight:900;filter:drop-shadow(0 6px 18px rgba(0,0,0,.5))}

    /* ã‚¯ãƒªã‚¢ç”»é¢ï¼ˆå…¨å•æ­£è§£å¾Œï¼‰ */
    #finish{position:fixed;inset:0;display:none;place-items:center;z-index:60;background:rgba(0,0,0,.6)}
    #finish.show{display:grid}
    .finishCard{background:#0f172a;border:1px solid #1f2937;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.4);padding:22px;min-width:min(94vw,560px);text-align:center}
    .big{font-size:clamp(28px,4.6vh,40px);margin:6px 0}
    .rankLine{font-size:clamp(40px,7vh,56px);font-weight:900;margin:4px 0}
    .meta{color:var(--muted);margin:6px 0 16px}
    .finishBtns{display:flex;gap:10px;justify-content:center}
    .finishBtns button{padding:12px 14px;border:none;border-radius:12px;background:#1f2937;color:#e6edf3}

    details#rank{max-width:560px;margin:0 auto;padding:8px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left}
    th{color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <header>åœ°å›³è¨˜å·4æŠãƒ‰ãƒªãƒ« â€” æ–‡å­—ç‰ˆï¼ˆå…¨å•æ­£è§£ã¾ã§ï¼‰</header>
  <main>
    <div class="wrap">
      <div class="symbolBox"><div id="qSymbol" class="symbol">?</div></div>
      <div id="choices" class="choices"></div>
      <div id="feedback"></div>
    </div>
  </main>

  <!-- æ­£èª¤ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="judge"><div id="judgeMark">â—¯</div><div style="position:absolute;bottom:16px;font-size:12px;color:#cbd5e1">è‡ªå‹•ã§æ¬¡ã®å•é¡Œã¸</div></div>

  <!-- ã‚¯ãƒªã‚¢ç”»é¢ï¼ˆé †ä½ãƒ»æ­£è§£ç‡ãƒ»æ™‚é–“ã‚’ä¸­å¤®ã«å¤§ããï¼‰ -->
  <div id="finish">
    <div class="finishCard">
      <div class="big">ğŸ‰ å…¨å•æ­£è§£ï¼ã‚¯ãƒªã‚¢</div>
      <div id="finRank" class="rankLine">1ä½</div>
      <div class="big">æ­£è§£ç‡ <b id="finAcc">100%</b> ï¼ æ™‚é–“ <b id="finTime">00:00</b></div>
      <div id="finGrade" class="rankLine">ğŸ‘‘ ç¥</div>
      <div class="meta">ï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¨˜éŒ²ã—ã¾ã—ãŸï¼‰</div>
      <div class="finishBtns">
        <button id="againBtn">ã‚‚ã†ä¸€åº¦</button>
        <button id="showRankBtn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
      </div>
    </div>
  </div>

  <details id="rank">
    <summary>ğŸ† ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæ—¥æ™‚ãƒ»æ­£è§£ç‡ãƒ»æ™‚é–“ã‚’è‡ªå‹•è¨˜éŒ²ï¼‰</summary>
    <table>
      <thead><tr><th>#</th><th>æ—¥æ™‚</th><th>æ­£è§£ç‡</th><th>æ™‚é–“</th></tr></thead>
      <tbody id="rankBody"></tbody>
    </table>
  </details>

  <footer><span id="progress">0/0</span>ã€€æ­£è§£ç‡:<span id="acc">0%</span></footer>

<script>
"use strict";

// ===== ãƒ‡ãƒ¼ã‚¿ï¼ˆæ–‡å­—ç‰ˆãƒ»å››æŠï¼‰ =====
const SYMBOLS = [
  {id:'post',name:'éƒµä¾¿å±€',char:'ã€’'},
  {id:'temple',name:'å¯ºé™¢',char:'å'},
  {id:'shrine',name:'ç¥ç¤¾',char:'â›©'},
  {id:'school',name:'å­¦æ ¡',char:'æ–‡'},
  {id:'hospital',name:'ç—…é™¢',char:'H'},
  {id:'parking',name:'é§è»Šå ´',char:'P'},
  {id:'factory',name:'å·¥å ´',char:'å·¥'},
  {id:'cityhall',name:'å¸‚å½¹æ‰€',char:'å¸‚'},
  {id:'police',name:'äº¤ç•ªãƒ»è­¦å¯Ÿç½²',char:'äº¤'},
  {id:'station',name:'é§…',char:'é§…'},
  {id:'mountain',name:'å±±é ‚',char:'â–³'},
  {id:'orchard',name:'æœæ¨¹åœ’',char:'æœ'},
  {id:'tea',name:'èŒ¶ç•‘',char:'èŒ¶'},
  {id:'paddy',name:'æ°´ç”°',char:'ç”°'},
  {id:'field',name:'ç•‘',char:'ç•‘'},
  {id:'lighthouse',name:'ç¯å°',char:'ç¯'}
];

// ===== util =====
const $ = s => document.querySelector(s);
const shuffle = a => a.map(x=>[Math.random(),x]).sort((m,n)=>m[0]-n[0]).map(x=>x[1]);
const two = n => String(n).padStart(2,"0");
const fmtTime = ms => { const t=Math.round(ms/1000); const m=Math.floor(t/60), s=t%60; return `${two(m)}:${two(s)}`; };
// æ­£ç­”ç‡ã«å¿œã˜ãŸæ ¼ä»˜ã‘ï¼ˆä¾‹ã®ã¾ã¾ï¼‰
function gradeLabel(pct){
  if(pct===100) return 'ğŸ‘‘ ç¥';
  if(pct>=80) return 'ğŸ¦ ç‹è€…';
  if(pct>=70) return 'ğŸ´ äººé–“';
  if(pct>=60) return 'ğŸ¢ äº€';
  if(pct>=50) return 'ğŸ› è™«';
  return 'ğŸ’€ åœ°ç„è¡Œã';
}

// ===== ranking (æ—¥æ™‚ã®ã¿) =====
const LS_KEY = "mapdrill_rank_char_v3"; // v3: ã‚¯ãƒªã‚¢ç”»é¢å¯¾å¿œ
const loadRank = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } };
const saveRank = (list) => localStorage.setItem(LS_KEY, JSON.stringify(list));
function pushRankWithReturn(acc,ms){
  const list = loadRank();
  const entry = {at:Date.now(), acc, ms};
  list.push(entry);
  list.sort((a,b)=> (b.acc-a.acc) || (a.ms-b.ms));
  const rankIndex = list.indexOf(entry); // 0-based
  saveRank(list.slice(0,50));
  renderRank();
  return {rank: rankIndex+1, total: list.length, entry};
}
function renderRank(){ const tb=$("#rankBody"); tb.innerHTML=""; loadRank().forEach((r,i)=>{ const d=new Date(r.at); const when = `${d.getFullYear()}/${two(d.getMonth()+1)}/${two(d.getDate())} ${two(d.getHours())}:${two(d.getMinutes())}`; const tr=document.createElement("tr"); tr.innerHTML = `<td>${i+1}</td><td>${when}</td><td>${Math.round(r.acc*100)}%</td><td>${fmtTime(r.ms)}</td>`; tb.appendChild(tr); }); }

// ===== quiz state =====
let queue=[], idx=0, attempts=0, correctClicks=0, startedAt=0;
let wrongSet = new Set();

function start(){
  queue = shuffle([...SYMBOLS]);
  idx=0; attempts=0; correctClicks=0; startedAt=performance.now();
  wrongSet.clear();
  next();
}

function next(){
  if(idx >= queue.length){
    if(wrongSet.size>0){
      // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼šä¸æ­£è§£ã®ã¿å‡ºé¡Œ
      queue = shuffle(SYMBOLS.filter(s=>wrongSet.has(s.id)));
      wrongSet.clear();
      idx = 0;
    }else{
      // å…¨å•æ­£è§£ã«åˆ°é”
      const acc = attempts? (correctClicks/attempts) : 0;
      const ms = performance.now()-startedAt;
      const res = pushRankWithReturn(acc, ms);
      // ç”»é¢ä¸­å¤®ã«å¤§ããè¡¨ç¤º
      $("#finRank").textContent = `${res.rank}ä½`;
      const pct = Math.round(acc*100);
      $("#finAcc").textContent = `${pct}%`;
      $("#finTime").textContent = fmtTime(ms);
      $("#finGrade").textContent = gradeLabel(pct);
      $("#finish").classList.add("show");
      return; // åœæ­¢
    }
  }

  const sym = queue[idx];
  $("#qSymbol").textContent = sym.char;

  const names = SYMBOLS.map(s=>s.name).filter(n=>n!==sym.name);
  const options = shuffle([sym.name, ...shuffle(names).slice(0,3)]); // å››æŠ
  const wrap = $("#choices"); wrap.innerHTML = "";
  options.forEach(n=>{
    const b=document.createElement("button"); b.textContent=n;
    b.onclick = () => answer(n, sym);
    wrap.appendChild(b);
  });

  $("#feedback").textContent = wrongSet.size? `å¾©ç¿’ä¸­ï¼šæ®‹ã‚Š ${queue.length-idx} å•` : "";
  $("#progress").textContent = `${idx+1}/${queue.length}`;
  $("#acc").textContent = attempts ? `${Math.round((correctClicks/attempts)*100)}%` : "0%";
}

function answer(sel, sym){
  attempts++;
  const ok = (sel === sym.name);
  if(ok){ correctClicks++; markButton(sel, true); showJudge(true); }
  else{ markButton(sel, false); wrongSet.add(sym.id); showJudge(false); }
  // æ¬¡ã¸
  setTimeout(()=>{ idx++; next(); }, 700);
}

function markButton(name, ok){
  const btns = Array.from(document.querySelectorAll('#choices button'));
  btns.forEach(b=>{ b.disabled=true; if(b.textContent===name){ b.classList.add(ok? 'correct':'wrong'); }});
}

function showJudge(isOK){
  const j = $("#judge"), m=$("#judgeMark");
  m.textContent = isOK ? "â—¯" : "Ã—";
  m.style.color = isOK ? "var(--ok)" : "var(--ng)";
  j.classList.add("show");
  navigator.vibrate?.(isOK ? 20 : [10,40,20]);
  setTimeout(()=> j.classList.remove("show"), 600);
}

// ã‚¯ãƒªã‚¢ç”»é¢ã®ãƒœã‚¿ãƒ³
$("#againBtn").addEventListener('click', ()=>{ $("#finish").classList.remove('show'); start(); });
$("#showRankBtn").addEventListener('click', ()=>{ $("#finish").classList.remove('show'); document.querySelector('#rank').open = true; });

// DOM æº–å‚™å¾Œã«é–‹å§‹
document.addEventListener("DOMContentLoaded", ()=>{ renderRank(); start(); });
</script>
</body>
</html>
