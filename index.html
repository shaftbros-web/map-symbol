<!DOCTYPE html><html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åœ°å›³è¨˜å·5æŠãƒ‰ãƒªãƒ« â€” SVGç‰ˆ</title>
  <meta name="description" content="ä¸­å­¦ç”Ÿå‘ã‘ï¼šåœ°å›³è¨˜å·ã‚’5æŠã§è¦šãˆã‚‹ã‚¹ãƒãƒ›ç”¨WEBã‚¢ãƒ—ãƒªï¼ˆSVGç”»åƒèª­ã¿è¾¼ã¿å¯¾å¿œç‰ˆï¼‰ã€‚GitHub Pagesã§å…¬é–‹ã—ã‚„ã™ã„å˜ä¸€HTMLã€‚" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <style>
    :root{ --bg:#0b0f14; --panel:#0f1520; --ink:#e6edf3; --muted:#9aa4b2; --accent:#60a5fa; --ok:#22c55e; --ng:#ef4444; --btn:#1f2937; --btn2:#111827; --card:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.25); }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;}
    #wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{background:var(--panel);padding:10px env(safe-area-inset-right,12px) 10px env(safe-area-inset-left,12px);border-bottom:1px solid #1f2937}
    footer{border-top:1px solid #1f2937;border-bottom:none;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    header h1{margin:0;font-size:18px;letter-spacing:.02em}
    header .sub{font-size:12px;color:var(--muted)}main{overflow:auto;padding:14px}
.board{max-width:680px;margin:0 auto;display:grid;gap:14px}

.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow);padding:14px}
.flex{display:flex;gap:12px;align-items:center}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.stat{background:var(--btn2);padding:10px;border-radius:12px;text-align:center;border:1px solid #1f2937}
.stat .v{font-size:18px;font-weight:700}
.stat .k{font-size:11px;color:var(--muted)}

.q-symbol{display:grid;place-items:center;height:240px;border-radius:16px;background:linear-gradient(180deg,#0d1625,#0b1220);border:1px solid #1e293b}
.glyph{font-size:110px;line-height:1}
.imgSym{width:170px;height:170px;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
.q-meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin-top:6px}

.choices{display:grid;gap:10px}
@media(min-width:520px){.choices{grid-template-columns:repeat(2,1fr)}}
.choice{border:1px solid #1f2937;background:var(--btn);color:var(--ink);padding:14px;border-radius:14px;text-align:left;font-size:16px;display:flex;gap:10px;align-items:center;position:relative;min-height:54px}
.choice .idx{width:28px;height:28px;border-radius:8px;background:#0b1220;border:1px solid #1f2937;display:grid;place-items:center;font-weight:700}
.choice.correct{outline:2px solid var(--ok);background:#0b1b12}
.choice.wrong{outline:2px solid var(--ng);background:#1a0f12}
.choice:disabled{opacity:.7}
.explain{font-size:12px;color:var(--muted)}

.controls{display:flex;gap:10px;flex-wrap:wrap}
button{appearance:none;border:none;background:var(--accent);color:#041221;padding:12px 14px;border-radius:12px;font-weight:700}
button.sec{background:var(--btn);color:var(--ink);border:1px solid #1f2937}
button.warn{background:#1f2937;color:#fca5a5;border:1px solid #7f1d1d}

.hidden{display:none !important}
.rank{width:100%;border-collapse:collapse;font-size:14px}
.rank th,.rank td{border-bottom:1px solid #1f2937;padding:8px}
.rank th{color:var(--muted);font-weight:600;text-align:left}

.tag{font-size:11px;color:#a3e635;background:#1a2b0f;border:1px solid #2c4a17;padding:2px 8px;border-radius:999px}

  </style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>åœ°å›³è¨˜å·5æŠãƒ‰ãƒªãƒ« <span class="sub">â€” SVGç”»åƒèª­ã¿è¾¼ã¿å¯¾å¿œ</span></h1>
  </header>
  <main>
    <div class="board">
      <section class="card" id="statsCard">
        <div class="stats">
          <div class="stat"><div class="v" id="statProgress">0/0</div><div class="k">é€²è¡ŒçŠ¶æ³</div></div>
          <div class="stat"><div class="v" id="statAcc">0%</div><div class="k">æ­£è§£ç‡ï¼ˆç·åˆï¼‰</div></div>
          <div class="stat"><div class="v" id="statTime">00:00</div><div class="k">çµŒéæ™‚é–“</div></div>
          <div class="stat"><div class="v" id="statStage">åˆå›</div><div class="k">ã‚¹ãƒ†ãƒ¼ã‚¸</div></div>
        </div>
      </section><section class="card" id="quizCard">
    <div class="q-symbol" id="qSymbol"></div>
    <div class="q-meta"><div id="qCounter">â€”</div><div id="hint" class="tag hidden">ä¸æ­£è§£ã®å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</div></div>
    <div class="choices" id="choices"></div>
    <div id="feedback" class="explain"></div>
    <div class="controls">
      <button id="nextBtn" class="sec hidden">ã¤ãã¸ â–¶</button>
      <button id="restartBtn" class="warn">æœ€åˆã‹ã‚‰</button>
    </div>
  </section>

  <section class="card hidden" id="finishCard">
    <h2 style="margin-top:0">ğŸ‰ å…¨å•æ­£è§£ï¼ã‚¯ãƒªã‚¢ï¼</h2>
    <p>ç·åˆæ­£è§£ç‡ <b id="finalAcc">â€”</b> ï¼ ã‚¯ãƒªã‚¢æ™‚é–“ <b id="finalTime">â€”</b></p>
    <div class="flex">
      <label for="playerName">åå‰ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ»ä»»æ„ï¼‰</label>
      <input id="playerName" placeholder="ä¾‹ï¼šTS" style="flex:1;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--ink)"/>
      <button id="saveScoreBtn">ä¿å­˜</button>
    </div>
    <div style="height:8px"></div>
    <h3 style="margin:6px 0 0">ğŸ† ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <table class="rank" id="rankTable">
      <thead><tr><th>#</th><th>åå‰</th><th>æ­£è§£ç‡</th><th>æ™‚é–“</th><th>æ—¥ä»˜</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="controls" style="margin-top:6px">
      <button id="againBtn">ã‚‚ã†ä¸€åº¦</button>
      <button id="clearRankBtn" class="warn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
    </div>
  </section>

  <section class="card" id="aboutCard">
    <details>
      <summary>ä½¿ã„æ–¹ãƒ»SVGã®ç½®ãæ–¹</summary>
      <ul>
        <li>ã“ã®ç‰ˆã¯ <b>symbols/</b> ãƒ•ã‚©ãƒ«ãƒ€ã® <b>SVG</b> ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã¯ <code>data</code> ã«æŒ‡å®šã—ãŸç›¸å¯¾ãƒ‘ã‚¹ã§ã™ã€‚</li>
        <li>SVGãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯ <b>fallbackChar</b>ï¼ˆä¾‹ï¼šã€’, å ãªã©ï¼‰ã§è¡¨ç¤ºã—ã¾ã™ã€‚</li>
        <li>GitHub Pages ã§å…¬é–‹ã™ã‚‹å ´åˆã€ã“ã® <code>index.html</code> ã¨ <code>symbols/</code> ã‚’åŒã˜éšå±¤ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚</li>
      </ul>
      <p style="margin:8px 0 0">å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹ï¼‰
      <code>symbols/post.svg, temple.svg, shrine.svg, school.svg, hospital.svg, parking.svg, factory.svg, cityhall.svg, police.svg, station.svg, mountain.svg, orchard.svg, tea.svg, paddy.svg, field.svg, lighthouse.svg</code></p>
    </details>
  </section>
</div>

  </main>
  <footer>
    <span class="sub">Â© 2025 Map Drill â€” SVGå¯¾å¿œï¼å˜ä¸€HTMLã€‚</span>
  </footer>
</div><script>
// ===================== ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆSVGèª­ã¿è¾¼ã¿ç‰ˆï¼‰ =====================
// kind: 'img' ã¯ SVGç”»åƒã‚’ <img> ã§èª­ã¿è¾¼ã¿ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ï¼‰ã€‚å¤±æ•—æ™‚ã¯ fallbackChar ã‚’è¡¨ç¤ºã€‚
const SYMBOLS = [
  {id:'post',       name:'éƒµä¾¿å±€',         kind:'img', data:'symbols/post.svg',       fallbackChar:'ã€’'},
  {id:'temple',     name:'å¯ºé™¢',           kind:'img', data:'symbols/temple.svg',     fallbackChar:'å', note:'åœ°å›³è¨˜å·ã®å¯ºé™¢ï¼ˆåï¼‰'},
  {id:'shrine',     name:'ç¥ç¤¾',           kind:'img', data:'symbols/shrine.svg',     fallbackChar:'â›©'},
  {id:'school',     name:'å­¦æ ¡',           kind:'img', data:'symbols/school.svg',     fallbackChar:'æ–‡'},
  {id:'hospital',   name:'ç—…é™¢',           kind:'img', data:'symbols/hospital.svg',   fallbackChar:'H'},
  {id:'parking',    name:'é§è»Šå ´',         kind:'img', data:'symbols/parking.svg',    fallbackChar:'P'},
  {id:'factory',    name:'å·¥å ´',           kind:'img', data:'symbols/factory.svg',    fallbackChar:'å·¥'},
  {id:'cityhall',   name:'å¸‚å½¹æ‰€',         kind:'img', data:'symbols/cityhall.svg',   fallbackChar:'å¸‚'},
  {id:'police',     name:'äº¤ç•ªãƒ»è­¦å¯Ÿç½²',   kind:'img', data:'symbols/police.svg',     fallbackChar:'äº¤'},
  {id:'station',    name:'é§…',             kind:'img', data:'symbols/station.svg',    fallbackChar:'é§…'},
  {id:'mountain',   name:'å±±é ‚',           kind:'img', data:'symbols/mountain.svg',   fallbackChar:'â–³'},
  {id:'orchard',    name:'æœæ¨¹åœ’',         kind:'img', data:'symbols/orchard.svg',    fallbackChar:'æœ'},
  {id:'tea',        name:'èŒ¶ç•‘',           kind:'img', data:'symbols/tea.svg',        fallbackChar:'èŒ¶'},
  {id:'paddy',      name:'æ°´ç”°',           kind:'img', data:'symbols/paddy.svg',      fallbackChar:'ç”°'},
  {id:'field',      name:'ç•‘',             kind:'img', data:'symbols/field.svg',      fallbackChar:'ç•‘'},
  {id:'lighthouse', name:'ç¯å°',           kind:'img', data:'symbols/lighthouse.svg', fallbackChar:'ç¯'},
];
const ALL_NAMES = SYMBOLS.map(s=>s.name);

// ===================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====================
const $ = s => document.querySelector(s);
const shuffle = arr => arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
const pad2 = n => String(n).padStart(2,'0');
const fmtTime = ms => { const t=Math.round(ms/1000); const m=Math.floor(t/60), s=t%60; return `${pad2(m)}:${pad2(s)}`; };

// ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰
function preloadImages(urls){
  urls.forEach(u=>{ const img = new Image(); img.src = u; });
}

// ===================== çŠ¶æ…‹ç®¡ç† =====================
let queue = [];
let wrongSet = new Set();
let current = null;
let idx = 0;
let stage = 'first';
let startAt = 0;
let totalAttempts = 0;
let totalCorrect = 0;
const perItemAttempts = {};

const LS_KEY = 'mapdrill_rank_v1_svg';

function resetAll(){
  queue = shuffle([...SYMBOLS]);
  wrongSet.clear();
  current = null;
  idx = 0;
  stage = 'first';
  startAt = performance.now();
  totalAttempts = 0;
  totalCorrect = 0;
  SYMBOLS.forEach(s=>perItemAttempts[s.id] = {tries:0, correctOnce:false});
  $('#finishCard').classList.add('hidden');
  $('#quizCard').classList.remove('hidden');
  $('#hint').classList.add('hidden');
  $('#feedback').textContent = '';
  $('#nextBtn').classList.add('hidden');
  renderStats();
  nextQuestion();
}

function renderStats(){
  $('#statProgress').textContent = `${idx}/${SYMBOLS.length}`;
  const acc = totalAttempts? Math.round((totalCorrect/totalAttempts)*100) : 0;
  $('#statAcc').textContent = `${acc}%`;
  const elapsed = performance.now()-startAt;
  $('#statTime').textContent = fmtTime(elapsed);
  $('#statStage').textContent = (stage==='first'? 'åˆå›':'å¾©ç¿’');
  if(stage==='review') $('#hint').classList.remove('hidden');
}

function renderSymbol(sym){
  const box = $('#qSymbol');
  box.innerHTML = '';
  if(sym.kind==='img'){
    const img = new Image();
    img.className = 'imgSym';
    img.alt = sym.name;
    img.src = sym.data;
    img.onerror = ()=>{
      // èª­ã¿è¾¼ã¿å¤±æ•— â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æç”»
      box.innerHTML = '';
      const d = document.createElement('div');
      d.className = 'glyph';
      d.textContent = sym.fallbackChar || 'ï¼Ÿ';
      box.appendChild(d);
    };
    box.appendChild(img);
  } else {
    const d = document.createElement('div');
    d.className = 'glyph';
    d.textContent = sym.data;
    box.appendChild(d);
  }
}

function pickChoices(answerName){
  const pool = ALL_NAMES.filter(n=>n!==answerName);
  const picks = shuffle(pool).slice(0,4);
  return shuffle([answerName, ...picks]);
}

function nextQuestion(){
  if(idx >= queue.length){
    if(stage==='first' && wrongSet.size>0){
      queue = shuffle([...SYMBOLS.filter(s=>wrongSet.has(s.id))]);
      wrongSet.clear();
      stage = 'review';
      idx = 0;
      $('#hint').classList.remove('hidden');
    }else{
      finish();
      return;
    }
  }
  current = queue[idx];
  renderSymbol(current);
  $('#qCounter').textContent = `å•é¡Œ ${idx+1} / ${queue.length}`;
  $('#feedback').textContent = '';

  const opts = pickChoices(current.name);
  const choiceWrap = $('#choices');
  choiceWrap.innerHTML = '';

  opts.forEach((name,i)=>{
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.innerHTML = `<span class="idx">${i+1}</span> <span>${name}</span>`;
    btn.addEventListener('click',()=>onAnswer(btn, name));
    choiceWrap.appendChild(btn);
  });

  $('#nextBtn').classList.add('hidden');
  renderStats();
}

function onAnswer(btn, chosenName){
  if(!current) return;
  totalAttempts++;
  perItemAttempts[current.id].tries++;

  const all = Array.from(document.querySelectorAll('.choice'));
  all.forEach(b=>b.disabled=true);

  const correct = (chosenName === current.name);
  const feedback = $('#feedback');

  if(correct){
    btn.classList.add('correct');
    feedback.innerHTML = `âœ… æ­£è§£ï¼š<b>${current.name}</b>${current.note? `ã€€<span class=\"explain\">${current.note}</span>`:''}`;
    if(!perItemAttempts[current.id].correctOnce){
      perItemAttempts[current.id].correctOnce = true;
      totalCorrect++;
    }
    navigator.vibrate?.(20);
  }else{
    btn.classList.add('wrong');
    const hit = Array.from(document.querySelectorAll('.choice')).find(b=>b.textContent.includes(current.name));
    if(hit) hit.classList.add('correct');
    feedback.textContent = `âŒ ä¸æ­£è§£ï¼šæ­£ã—ãã¯ã€Œ${current.name}ã€`;
    wrongSet.add(current.id);
    navigator.vibrate?.([10,40,20]);
  }

  $('#nextBtn').classList.remove('hidden');
  renderStats();
}

function finish(){
  const elapsed = performance.now()-startAt;
  $('#finalAcc').textContent = `${Math.round((totalCorrect/totalAttempts)*100)}%`;
  $('#finalTime').textContent = fmtTime(elapsed);
  renderRanking();
  $('#quizCard').classList.add('hidden');
  $('#finishCard').classList.remove('hidden');
}

function renderRanking(){
  const tbody = $('#rankTable tbody');
  tbody.innerHTML = '';
  const list = loadRank();
  list.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.name||'-'}</td><td>${Math.round(r.acc*100)}%</td><td>${fmtTime(r.ms)}</td><td>${new Date(r.at).toLocaleDateString()}</td>`;
    tbody.appendChild(tr);
  });
}

function loadRank(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{return []} }
function saveRank(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

function pushScore(){
  const name = $('#playerName').value.trim();
  const ms = performance.now()-startAt;
  const acc = totalAttempts? (totalCorrect/totalAttempts) : 0;
  const entry = {name, ms, acc, at: Date.now()};
  const list = loadRank();
  list.push(entry);
  list.sort((a,b)=> (b.acc-a.acc) || (a.ms-b.ms));
  saveRank(list.slice(0,50));
  renderRanking();
}

// ===================== ã‚¤ãƒ™ãƒ³ãƒˆ =====================
$('#nextBtn').addEventListener('click', ()=>{ idx++; nextQuestion(); });
$('#restartBtn').addEventListener('click', ()=>{ if(confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) resetAll(); });
$('#againBtn').addEventListener('click', resetAll);
$('#saveScoreBtn').addEventListener('click', pushScore);
$('#clearRankBtn').addEventListener('click', ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(LS_KEY); renderRanking(); }});

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆ1ç§’æ¯ï¼‰
setInterval(()=>{ if($('#quizCard')&&!$('#quizCard').classList.contains('hidden')) renderStats(); }, 1000);

// èµ·å‹•ï¼šSVGãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ â†’ ãƒªã‚»ãƒƒãƒˆ
preloadImages(SYMBOLS.filter(s=>s.kind==='img').map(s=>s.data));
resetAll();
</script></body>
</html>.choice{
  border:1px solid #1f2937;background:var(--btn);color:var(--ink);padding:14px;border-radius:14px;text-align:left;font-size:16px;
  display:flex;gap:10px;align-items:center;position:relative;min-height:54px
}
.choice .idx{width:28px;height:28px;border-radius:8px;background:#0b1220;border:1px solid #1f2937;display:grid;place-items:center;font-weight:700}
.choice.correct{outline:2px solid var(--ok);background:#0b1b12}
.choice.wrong{outline:2px solid var(--ng);background:#1a0f12}
.choice:disabled{opacity:.7}
.explain{font-size:12px;color:var(--muted)}

.controls{display:flex;gap:10px;flex-wrap:wrap}
button{appearance:none;border:none;background:var(--accent);color:#041221;padding:12px 14px;border-radius:12px;font-weight:700}
button.sec{background:var(--btn);color:var(--ink);border:1px solid #1f2937}
button.warn{background:#1f2937;color:#fca5a5;border:1px solid #7f1d1d}

.hidden{display:none !important}
.rank{width:100%;border-collapse:collapse;font-size:14px}
.rank th,.rank td{border-bottom:1px solid #1f2937;padding:8px}
.rank th{color:var(--muted);font-weight:600;text-align:left}

.tag{font-size:11px;color:#a3e635;background:#1a2b0f;border:1px solid #2c4a17;padding:2px 8px;border-radius:999px}

  </style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>åœ°å›³è¨˜å·5æŠãƒ‰ãƒªãƒ« <span class="sub">â€” ä¸­å­¦ç”Ÿå‘ã‘ãƒ»ã‚¹ãƒãƒ›æœ€é©åŒ–</span></h1>
  </header>
  <main>
    <div class="board">
      <section class="card" id="statsCard">
        <div class="stats">
          <div class="stat"><div class="v" id="statProgress">0/0</div><div class="k">é€²è¡ŒçŠ¶æ³</div></div>
          <div class="stat"><div class="v" id="statAcc">0%</div><div class="k">æ­£è§£ç‡ï¼ˆç·åˆï¼‰</div></div>
          <div class="stat"><div class="v" id="statTime">00:00</div><div class="k">çµŒéæ™‚é–“</div></div>
          <div class="stat"><div class="v" id="statStage">åˆå›</div><div class="k">ã‚¹ãƒ†ãƒ¼ã‚¸</div></div>
        </div>
      </section><section class="card" id="quizCard">
    <div class="q-symbol" id="qSymbol"></div>
    <div class="q-meta"><div id="qCounter">â€”</div><div id="hint" class="tag hidden">ä¸æ­£è§£ã®å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</div></div>
    <div class="choices" id="choices"></div>
    <div id="feedback" class="explain"></div>
    <div class="controls">
      <button id="nextBtn" class="sec hidden">ã¤ãã¸ â–¶</button>
      <button id="restartBtn" class="warn">æœ€åˆã‹ã‚‰</button>
    </div>
  </section>

  <section class="card hidden" id="finishCard">
    <h2 style="margin-top:0">ğŸ‰ å…¨å•æ­£è§£ï¼ã‚¯ãƒªã‚¢ï¼</h2>
    <p>ç·åˆæ­£è§£ç‡ <b id="finalAcc">â€”</b> ï¼ ã‚¯ãƒªã‚¢æ™‚é–“ <b id="finalTime">â€”</b></p>
    <div class="flex">
      <label for="playerName">åå‰ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ»ä»»æ„ï¼‰</label>
      <input id="playerName" placeholder="ä¾‹ï¼šTS" style="flex:1;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--ink)"/>
      <button id="saveScoreBtn">ä¿å­˜</button>
    </div>
    <div style="height:8px"></div>
    <h3 style="margin:6px 0 0">ğŸ† ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <table class="rank" id="rankTable">
      <thead><tr><th>#</th><th>åå‰</th><th>æ­£è§£ç‡</th><th>æ™‚é–“</th><th>æ—¥ä»˜</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="controls" style="margin-top:6px">
      <button id="againBtn">ã‚‚ã†ä¸€åº¦</button>
      <button id="clearRankBtn" class="warn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
    </div>
  </section>

  <section class="card" id="aboutCard">
    <details>
      <summary>ä½¿ã„æ–¹ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</summary>
      <ul>
        <li>5æŠÃ—1å•ãšã¤ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºã€‚å…¨å•çµ‚äº†å¾Œã€ä¸æ­£è§£ã ã‘ã‚’ãƒ©ãƒ³ãƒ€ãƒ å†å‡ºé¡Œã—ã€å…¨ã¦æ­£è§£ã«ãªã‚‹ã¾ã§ç¶šãã¾ã™ã€‚</li>
        <li>çµ‚äº†æ™‚ã« <b>æ­£è§£ç‡ãƒ»æ™‚é–“</b> ã‚’è¡¨ç¤ºã—ã€ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ã« <b>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</b> ã‚’ä¿å­˜ã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒä¸è¦ï¼‰ã€‚</li>
        <li>è¨˜å·ã¯ <code>SYMBOLS</code> é…åˆ—ã§ç®¡ç†ã€‚<code>kind</code> ãŒ <code>char</code> ãªã‚‰æ–‡å­—ã‚„çµµæ–‡å­—ã€<code>img</code> ãªã‚‰ <code>data</code> ã«ç”»åƒãƒ‘ã‚¹ï¼ˆPNG/SVGï¼‰ã‚’æŒ‡å®šã§ãã¾ã™ã€‚</li>
        <li>GitHub Pages ã§å…¬é–‹ã™ã‚‹å ´åˆã€ã“ã® <code>index.html</code> ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ãã€Settings â†’ Pages â†’ Deploy from a branch â†’ <b>main / root</b> ã‚’é¸æŠã€‚</li>
      </ul>
    </details>
  </section>
</div>

  </main>
  <footer>
    <span class="sub">Â© 2025 Map Drill â€” å˜ä¸€HTML/JSã€‚ãƒ‡ãƒ¼ã‚¿å·®ã—æ›¿ãˆè‡ªç”±ã€‚</span>
  </footer>
</div><script>
// ===================== ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦å·®ã—æ›¿ãˆï¼‰ =====================
// kind: 'char' ã¯æ–‡å­—ãƒ»çµµæ–‡å­—ãƒ»ç°¡æ˜“è¨˜å·ã€'img' ã¯ç”»åƒï¼ˆç›¸å¯¾ãƒ‘ã‚¹ or data URIï¼‰
const SYMBOLS = [
  {id:'post',     name:'éƒµä¾¿å±€',         kind:'char', data:'ã€’'},
  {id:'temple',   name:'å¯ºé™¢',           kind:'char', data:'å', note:'â€»åœ°å›³ã§ã¯å¯ºé™¢ã‚’ç¤ºã™è¨˜å·ï¼ˆåï¼‰'},
  {id:'shrine',   name:'ç¥ç¤¾',           kind:'char', data:'â›©'},
  {id:'school',   name:'å­¦æ ¡',           kind:'char', data:'æ–‡'},
  {id:'hospital', name:'ç—…é™¢',           kind:'char', data:'H'},
  {id:'parking',  name:'é§è»Šå ´',         kind:'char', data:'P'},
  {id:'factory',  name:'å·¥å ´',           kind:'char', data:'å·¥'},
  {id:'cityhall', name:'å¸‚å½¹æ‰€',         kind:'char', data:'å¸‚'},
  {id:'police',   name:'äº¤ç•ªãƒ»è­¦å¯Ÿç½²',   kind:'char', data:'äº¤'},
  {id:'station',  name:'é§…',             kind:'char', data:'é§…'},
  {id:'mountain', name:'å±±é ‚',           kind:'char', data:'â–³'},
  {id:'orchard',  name:'æœæ¨¹åœ’',         kind:'char', data:'æœ'},
  {id:'tea',      name:'èŒ¶ç•‘',           kind:'char', data:'èŒ¶'},
  {id:'paddy',    name:'æ°´ç”°',           kind:'char', data:'ç”°'},
  {id:'field',    name:'ç•‘',             kind:'char', data:'ç•‘'},
  {id:'lighthouse', name:'ç¯å°',         kind:'char', data:'ç¯'},
];

// 5æŠç”¨ã«èª¤ç­”å€™è£œã‚’ç”Ÿæˆã™ã‚‹ã¨ãã€åŒã˜ã‚«ãƒ†ã‚´ãƒªåãŒæ··åœ¨ã—ãªã„ã‚ˆã†ã«åå‰ã§åˆ¤å®š
const ALL_NAMES = SYMBOLS.map(s=>s.name);

// ===================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====================
const $ = s => document.querySelector(s);
const shuffle = arr => arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
const pad2 = n => String(n).padStart(2,'0');
const fmtTime = ms => { const t=Math.round(ms/1000); const m=Math.floor(t/60), s=t%60; return `${pad2(m)}:${pad2(s)}`; };

// ===================== çŠ¶æ…‹ç®¡ç† =====================
let queue = [];            // å‡ºé¡Œã‚­ãƒ¥ãƒ¼ï¼ˆåˆå› â†’ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰
let wrongSet = new Set();  // ä¸æ­£è§£ã®IDé›†åˆ
let current = null;        // ç¾åœ¨ã®å•é¡Œï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
let idx = 0;               // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0-basedï¼‰
let stage = 'first';       // 'first' | 'review'
let startAt = 0;           // é–‹å§‹æ™‚åˆ»
let totalAttempts = 0;     // ç·å›ç­”æ•°
let totalCorrect = 0;      // ç·æ­£è§£æ•°
const perItemAttempts = {}; // id -> {tries, correctOnce}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
const LS_KEY = 'mapdrill_rank_v1';

function resetAll(){
  queue = shuffle([...SYMBOLS]);
  wrongSet.clear();
  current = null;
  idx = 0;
  stage = 'first';
  startAt = performance.now();
  totalAttempts = 0;
  totalCorrect = 0;
  SYMBOLS.forEach(s=>perItemAttempts[s.id] = {tries:0, correctOnce:false});
  $('#finishCard').classList.add('hidden');
  $('#quizCard').classList.remove('hidden');
  $('#hint').classList.add('hidden');
  $('#feedback').textContent = '';
  $('#nextBtn').classList.add('hidden');
  renderStats();
  nextQuestion();
}

function renderStats(){
  $('#statProgress').textContent = `${idx}/${SYMBOLS.length}`;
  const acc = totalAttempts? Math.round((totalCorrect/totalAttempts)*100) : 0;
  $('#statAcc').textContent = `${acc}%`;
  const elapsed = performance.now()-startAt;
  $('#statTime').textContent = fmtTime(elapsed);
  $('#statStage').textContent = (stage==='first'? 'åˆå›':'å¾©ç¿’');
  if(stage==='review') $('#hint').classList.remove('hidden');
}

function renderSymbol(sym){
  const box = $('#qSymbol');
  box.innerHTML = '';
  if(sym.kind==='char'){
    const d = document.createElement('div');
    d.className = 'glyph';
    d.textContent = sym.data;
    box.appendChild(d);
  }else if(sym.kind==='img'){
    const img = document.createElement('img');
    img.className = 'imgSym';
    img.src = sym.data; // ä¾‹: 'symbols/post.png'
    img.alt = sym.name;
    box.appendChild(img);
  }
}

function pickChoices(answerName){
  const pool = ALL_NAMES.filter(n=>n!==answerName);
  const picks = shuffle(pool).slice(0,4);
  const list = shuffle([answerName, ...picks]);
  return list;
}

function nextQuestion(){
  // ã‚¯ãƒªã‚¢åˆ¤å®š
  if(idx >= queue.length){
    if(stage==='first' && wrongSet.size>0){
      // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã«çªå…¥
      queue = shuffle([...SYMBOLS.filter(s=>wrongSet.has(s.id))]);
      wrongSet.clear();
      stage = 'review';
      idx = 0;
      $('#hint').classList.remove('hidden');
    }else{
      // å®Œäº†
      finish();
      return;
    }
  }

  current = queue[idx];
  renderSymbol(current);
  $('#qCounter').textContent = `å•é¡Œ ${idx+1} / ${queue.length}`;
  $('#feedback').textContent = '';

  const opts = pickChoices(current.name);
  const choiceWrap = $('#choices');
  choiceWrap.innerHTML = '';

  opts.forEach((name,i)=>{
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.innerHTML = `<span class="idx">${i+1}</span> <span>${name}</span>`;
    btn.addEventListener('click',()=>onAnswer(btn, name));
    choiceWrap.appendChild(btn);
  });

  $('#nextBtn').classList.add('hidden');
  renderStats();
}

function onAnswer(btn, chosenName){
  if(!current) return;
  totalAttempts++;
  perItemAttempts[current.id].tries++;

  const all = Array.from(document.querySelectorAll('.choice'));
  all.forEach(b=>b.disabled=true);

  const correct = (chosenName === current.name);
  const feedback = $('#feedback');

  if(correct){
    btn.classList.add('correct');
    feedback.innerHTML = `âœ… æ­£è§£ï¼š<b>${current.name}</b>${current.note? `ã€€<span class="explain">${current.note}</span>`:''}`;
    if(!perItemAttempts[current.id].correctOnce){
      perItemAttempts[current.id].correctOnce = true;
      totalCorrect++;
    }
    navigator.vibrate?.(20);
  }else{
    btn.classList.add('wrong');
    // æ­£è§£ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const hit = Array.from(document.querySelectorAll('.choice')).find(b=>b.textContent.includes(current.name));
    if(hit) hit.classList.add('correct');
    feedback.textContent = `âŒ ä¸æ­£è§£ï¼šæ­£ã—ãã¯ã€Œ${current.name}ã€`;
    wrongSet.add(current.id);
    navigator.vibrate?.([10,40,20]);
  }

  $('#nextBtn').classList.remove('hidden');
  renderStats();
}

function finish(){
  const elapsed = performance.now()-startAt;
  $('#finalAcc').textContent = `${Math.round((totalCorrect/totalAttempts)*100)}%`;
  $('#finalTime').textContent = fmtTime(elapsed);

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  renderRanking();

  $('#quizCard').classList.add('hidden');
  $('#finishCard').classList.remove('hidden');
}

function renderRanking(){
  const tbody = $('#rankTable tbody');
  tbody.innerHTML = '';
  const list = loadRank();
  list.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.name||'-'}</td><td>${Math.round(r.acc*100)}%</td><td>${fmtTime(r.ms)}</td><td>${new Date(r.at).toLocaleDateString()}</td>`;
    tbody.appendChild(tr);
  });
}

function loadRank(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{return []}
}
function saveRank(list){
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}

function pushScore(){
  const name = $('#playerName').value.trim();
  const ms = performance.now()-startAt;
  const acc = totalAttempts? (totalCorrect/totalAttempts) : 0;
  const entry = {name, ms, acc, at: Date.now()};
  const list = loadRank();
  list.push(entry);
  // ã‚½ãƒ¼ãƒˆï¼šæ­£è§£ç‡â†“ â†’ æ™‚é–“â†‘
  list.sort((a,b)=> (b.acc-a.acc) || (a.ms-b.ms));
  // ä¸Šä½50ä»¶ã¾ã§
  saveRank(list.slice(0,50));
  renderRanking();
}

// ===================== ã‚¤ãƒ™ãƒ³ãƒˆ =====================
$('#nextBtn').addEventListener('click', ()=>{ idx++; nextQuestion(); });
$('#restartBtn').addEventListener('click', ()=>{ if(confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) resetAll(); });
$('#againBtn').addEventListener('click', resetAll);
$('#saveScoreBtn').addEventListener('click', pushScore);
$('#clearRankBtn').addEventListener('click', ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ saveRank([]); renderRanking(); }});

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–°ï¼ˆ1ç§’æ¯ï¼‰
setInterval(()=>{ if($('#quizCard')&&!$('#quizCard').classList.contains('hidden')) renderStats(); }, 1000);

// èµ·å‹•
resetAll();
</script></body>
</html>.choice{
  border:1px solid #1f2937;background:var(--btn);color:var(--ink);padding:14px;border-radius:14px;text-align:left;font-size:16px;
  display:flex;gap:10px;align-items:center;position:relative;min-height:54px
}
.choice .idx{width:28px;height:28px;border-radius:8px;background:#0b1220;border:1px solid #1f2937;display:grid;place-items:center;font-weight:700}
.choice.correct{outline:2px solid var(--ok);background:#0b1b12}
.choice.wrong{outline:2px solid var(--ng);background:#1a0f12}
.choice:disabled{opacity:.7}
.explain{font-size:12px;color:var(--muted)}

.controls{display:flex;gap:10px;flex-wrap:wrap}
button{appearance:none;border:none;background:var(--accent);color:#041221;padding:12px 14px;border-radius:12px;font-weight:700}
button.sec{background:var(--btn);color:var(--ink);border:1px solid #1f2937}
button.warn{background:#1f2937;color:#fca5a5;border:1px solid #7f1d1d}

.hidden{display:none !important}
.rank{width:100%;border-collapse:collapse;font-size:14px}
.rank th,.rank td{border-bottom:1px solid #1f2937;padding:8px}
.rank th{color:var(--muted);font-weight:600;text-align:left}

.tag{font-size:11px;color:#a3e635;background:#1a2b0f;border:1px solid #2c4a17;padding:2px 8px;border-radius:999px}

  </style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>åœ°å›³è¨˜å·5æŠãƒ‰ãƒªãƒ« <span class="sub">â€” ä¸­å­¦ç”Ÿå‘ã‘ãƒ»ã‚¹ãƒãƒ›æœ€é©åŒ–</span></h1>
  </header>
  <main>
    <div class="board">
      <section class="card" id="statsCard">
        <div class="stats">
          <div class="stat"><div class="v" id="statProgress">0/0</div><div class="k">é€²è¡ŒçŠ¶æ³</div></div>
          <div class="stat"><div class="v" id="statAcc">0%</div><div class="k">æ­£è§£ç‡ï¼ˆç·åˆï¼‰</div></div>
          <div class="stat"><div class="v" id="statTime">00:00</div><div class="k">çµŒéæ™‚é–“</div></div>
          <div class="stat"><div class="v" id="statStage">åˆå›</div><div class="k">ã‚¹ãƒ†ãƒ¼ã‚¸</div></div>
        </div>
      </section><section class="card" id="quizCard">
    <div class="q-symbol" id="qSymbol"></div>
    <div class="q-meta"><div id="qCounter">â€”</div><div id="hint" class="tag hidden">ä¸æ­£è§£ã®å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</div></div>
    <div class="choices" id="choices"></div>
    <div id="feedback" class="explain"></div>
    <div class="controls">
      <button id="nextBtn" class="sec hidden">ã¤ãã¸ â–¶</button>
      <button id="restartBtn" class="warn">æœ€åˆã‹ã‚‰</button>
    </div>
  </section>

  <section class="card hidden" id="finishCard">
    <h2 style="margin-top:0">ğŸ‰ å…¨å•æ­£è§£ï¼ã‚¯ãƒªã‚¢ï¼</h2>
    <p>ç·åˆæ­£è§£ç‡ <b id="finalAcc">â€”</b> ï¼ ã‚¯ãƒªã‚¢æ™‚é–“ <b id="finalTime">â€”</b></p>
    <div class="flex">
      <label for="playerName">åå‰ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ»ä»»æ„ï¼‰</label>
      <input id="playerName" placeholder="ä¾‹ï¼šTS" style="flex:1;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--ink)"/>
      <button id="saveScoreBtn">ä¿å­˜</button>
    </div>
    <div style="height:8px"></div>
    <h3 style="margin:6px 0 0">ğŸ† ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <table class="rank" id="rankTable">
      <thead><tr><th>#</th><th>åå‰</th><th>æ­£è§£ç‡</th><th>æ™‚é–“</th><th>æ—¥ä»˜</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="controls" style="margin-top:6px">
      <button id="againBtn">ã‚‚ã†ä¸€åº¦</button>
      <button id="clearRankBtn" class="warn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
    </div>
  </section>

  <section class="card" id="aboutCard">
    <details>
      <summary>ä½¿ã„æ–¹ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</summary>
      <ul>
        <li>5æŠÃ—1å•ãšã¤ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºã€‚å…¨å•çµ‚äº†å¾Œã€ä¸æ­£è§£ã ã‘ã‚’ãƒ©ãƒ³ãƒ€ãƒ å†å‡ºé¡Œã—ã€å…¨ã¦æ­£è§£ã«ãªã‚‹ã¾ã§ç¶šãã¾ã™ã€‚</li>
        <li>çµ‚äº†æ™‚ã« <b>æ­£è§£ç‡ãƒ»æ™‚é–“</b> ã‚’è¡¨ç¤ºã—ã€ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ã« <b>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</b> ã‚’ä¿å­˜ã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒä¸è¦ï¼‰ã€‚</li>
        <li>è¨˜å·ã¯ <code>SYMBOLS</code> é…åˆ—ã§ç®¡ç†ã€‚<code>kind</code> ãŒ <code>char</code> ãªã‚‰æ–‡å­—ã‚„çµµæ–‡å­—ã€<code>img</code> ãªã‚‰ <code>data</code> ã«ç”»åƒãƒ‘ã‚¹ï¼ˆPNG/SVGï¼‰ã‚’æŒ‡å®šã§ãã¾ã™ã€‚</li>
        <li>GitHub Pages ã§å…¬é–‹ã™ã‚‹å ´åˆã€ã“ã® <code>index.html</code> ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ãã€Settings â†’ Pages â†’ Deploy from a branch â†’ <b>main / root</b> ã‚’é¸æŠã€‚</li>
      </ul>
    </details>
  </section>
</div>

  </main>
  <footer>
    <span class="sub">Â© 2025 Map Drill â€” å˜ä¸€HTML/JSã€‚ãƒ‡ãƒ¼ã‚¿å·®ã—æ›¿ãˆè‡ªç”±ã€‚</span>
  </footer>
</div><script>
// ===================== ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦å·®ã—æ›¿ãˆï¼‰ =====================
// kind: 'char' ã¯æ–‡å­—ãƒ»çµµæ–‡å­—ãƒ»ç°¡æ˜“è¨˜å·ã€'img' ã¯ç”»åƒï¼ˆç›¸å¯¾ãƒ‘ã‚¹ or data URIï¼‰
const SYMBOLS = [
  {id:'post',     name:'éƒµä¾¿å±€',         kind:'char', data:'ã€’'},
  {id:'temple',   name:'å¯ºé™¢',           kind:'char', data:'å', note:'â€»åœ°å›³ã§ã¯å¯ºé™¢ã‚’ç¤ºã™è¨˜å·ï¼ˆåï¼‰'},
  {id:'shrine',   name:'ç¥ç¤¾',           kind:'char', data:'â›©'},
  {id:'school',   name:'å­¦æ ¡',           kind:'char', data:'æ–‡'},
  {id:'hospital', name:'ç—…é™¢',           kind:'char', data:'H'},
  {id:'parking',  name:'é§è»Šå ´',         kind:'char', data:'P'},
  {id:'factory',  name:'å·¥å ´',           kind:'char', data:'å·¥'},
  {id:'cityhall', name:'å¸‚å½¹æ‰€',         kind:'char', data:'å¸‚'},
  {id:'police',   name:'äº¤ç•ªãƒ»è­¦å¯Ÿç½²',   kind:'char', data:'äº¤'},
  {id:'station',  name:'é§…',             kind:'char', data:'é§…'},
  {id:'mountain', name:'å±±é ‚',           kind:'char', data:'â–³'},
  {id:'orchard',  name:'æœæ¨¹åœ’',         kind:'char', data:'æœ'},
  {id:'tea',      name:'èŒ¶ç•‘',           kind:'char', data:'èŒ¶'},
  {id:'paddy',    name:'æ°´ç”°',           kind:'char', data:'ç”°'},
  {id:'field',    name:'ç•‘',             kind:'char', data:'ç•‘'},
  {id:'lighthouse', name:'ç¯å°',         kind:'char', data:'ç¯'},
];

// 5æŠç”¨ã«èª¤ç­”å€™è£œã‚’ç”Ÿæˆã™ã‚‹ã¨ãã€åŒã˜ã‚«ãƒ†ã‚´ãƒªåãŒæ··åœ¨ã—ãªã„ã‚ˆã†ã«åå‰ã§åˆ¤å®š
const ALL_NAMES = SYMBOLS.map(s=>s.name);

// ===================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====================
const $ = s => document.querySelector(s);
const shuffle = arr => arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
const pad2 = n => String(n).padStart(2,'0');
const fmtTime = ms => { const t=Math.round(ms/1000); const m=Math.floor(t/60), s=t%60; return `${pad2(m)}:${pad2(s)}`; };

// ===================== çŠ¶æ…‹ç®¡ç† =====================
let queue = [];            // å‡ºé¡Œã‚­ãƒ¥ãƒ¼ï¼ˆåˆå› â†’ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰
let wrongSet = new Set();  // ä¸æ­£è§£ã®IDé›†åˆ
let current = null;        // ç¾åœ¨ã®å•é¡Œï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
let idx = 0;               // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0-basedï¼‰
let stage = 'first';       // 'first' | 'review'
let startAt = 0;           // é–‹å§‹æ™‚åˆ»
let totalAttempts = 0;     // ç·å›ç­”æ•°
let totalCorrect = 0;      // ç·æ­£è§£æ•°
const perItemAttempts = {}; // id -> {tries, correctOnce}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
const LS_KEY = 'mapdrill_rank_v1';

function resetAll(){
  queue = shuffle([...SYMBOLS]);
  wrongSet.clear();
  current = null;
  idx = 0;
  stage = 'first';
  startAt = performance.now();
  totalAttempts = 0;
  totalCorrect = 0;
  SYMBOLS.forEach(s=>perItemAttempts[s.id] = {tries:0, correctOnce:false});
  $('#finishCard').classList.add('hidden');
  $('#quizCard').classList.remove('hidden');
  $('#hint').classList.add('hidden');
  $('#feedback').textContent = '';
  $('#nextBtn').classList.add('hidden');
  renderStats();
  nextQuestion();
}

function renderStats(){
  $('#statProgress').textContent = `${idx}/${SYMBOLS.length}`;
  const acc = totalAttempts? Math.round((totalCorrect/totalAttempts)*100) : 0;
  $('#statAcc').textContent = `${acc}%`;
  const elapsed = performance.now()-startAt;
  $('#statTime').textContent = fmtTime(elapsed);
  $('#statStage').textContent = (stage==='first'? 'åˆå›':'å¾©ç¿’');
  if(stage==='review') $('#hint').classList.remove('hidden');
}

function renderSymbol(sym){
  const box = $('#qSymbol');
  box.innerHTML = '';
  if(sym.kind==='char'){
    const d = document.createElement('div');
    d.className = 'glyph';
    d.textContent = sym.data;
    box.appendChild(d);
  }else if(sym.kind==='img'){
    const img = document.createElement('img');
    img.className = 'imgSym';
    img.src = sym.data; // ä¾‹: 'symbols/post.png'
    img.alt = sym.name;
    box.appendChild(img);
  }
}

function pickChoices(answerName){
  const pool = ALL_NAMES.filter(n=>n!==answerName);
  const picks = shuffle(pool).slice(0,4);
  const list = shuffle([answerName, ...picks]);
  return list;
}

function nextQuestion(){
  // ã‚¯ãƒªã‚¢åˆ¤å®š
  if(idx >= queue.length){
    if(stage==='first' && wrongSet.size>0){
      // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã«çªå…¥
      queue = shuffle([...SYMBOLS.filter(s=>wrongSet.has(s.id))]);
      wrongSet.clear();
      stage = 'review';
      idx = 0;
      $('#hint').classList.remove('hidden');
    }else{
      // å®Œäº†
      finish();
      return;
    }
  }

  current = queue[idx];
  renderSymbol(current);
  $('#qCounter').textContent = `å•é¡Œ ${idx+1} / ${queue.length}`;
  $('#feedback').textContent = '';

  const opts = pickChoices(current.name);
  const choiceWrap = $('#choices');
  choiceWrap.innerHTML = '';

  opts.forEach((name,i)=>{
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.innerHTML = `<span class="idx">${i+1}</span> <span>${name}</span>`;
    btn.addEventListener('click',()=>onAnswer(btn, name));
    choiceWrap.appendChild(btn);
  });

  $('#nextBtn').classList.add('hidden');
  renderStats();
}

function onAnswer(btn, chosenName){
  if(!current) return;
  totalAttempts++;
  perItemAttempts[current.id].tries++;

  const all = Array.from(document.querySelectorAll('.choice'));
  all.forEach(b=>b.disabled=true);

  const correct = (chosenName === current.name);
  const feedback = $('#feedback');

  if(correct){
    btn.classList.add('correct');
    feedback.innerHTML = `âœ… æ­£è§£ï¼š<b>${current.name}</b>${current.note? `ã€€<span class="explain">${current.note}</span>`:''}`;
    if(!perItemAttempts[current.id].correctOnce){
      perItemAttempts[current.id].correctOnce = true;
      totalCorrect++;
    }
    navigator.vibrate?.(20);
  }else{
    btn.classList.add('wrong');
    // æ­£è§£ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const hit = Array.from(document.querySelectorAll('.choice')).find(b=>b.textContent.includes(current.name));
    if(hit) hit.classList.add('correct');
    feedback.textContent = `âŒ ä¸æ­£è§£ï¼šæ­£ã—ãã¯ã€Œ${current.name}ã€`;
    wrongSet.add(current.id);
    navigator.vibrate?.([10,40,20]);
  }

  $('#nextBtn').classList.remove('hidden');
  renderStats();
}

function finish(){
  const elapsed = performance.now()-startAt;
  $('#finalAcc').textContent = `${Math.round((totalCorrect/totalAttempts)*100)}%`;
  $('#finalTime').textContent = fmtTime(elapsed);

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  renderRanking();

  $('#quizCard').classList.add('hidden');
  $('#finishCard').classList.remove('hidden');
}

function renderRanking(){
  const tbody = $('#rankTable tbody');
  tbody.innerHTML = '';
  const list = loadRank();
  list.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.name||'-'}</td><td>${Math.round(r.acc*100)}%</td><td>${fmtTime(r.ms)}</td><td>${new Date(r.at).toLocaleDateString()}</td>`;
    tbody.appendChild(tr);
  });
}

function loadRank(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{return []}
}
function saveRank(list){
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}

function pushScore(){
  const name = $('#playerName').value.trim();
  const ms = performance.now()-startAt;
  const acc = totalAttempts? (totalCorrect/totalAttempts) : 0;
  const entry = {name, ms, acc, at: Date.now()};
  const list = loadRank();
  list.push(entry);
  // ã‚½ãƒ¼ãƒˆï¼šæ­£è§£ç‡â†“ â†’ æ™‚é–“â†‘
  list.sort((a,b)=> (b.acc-a.acc) || (a.ms-b.ms));
  // ä¸Šä½50ä»¶ã¾ã§
  saveRank(list.slice(0,50));
  renderRanking();
}

// ===================== ã‚¤ãƒ™ãƒ³ãƒˆ =====================
$('#nextBtn').addEventListener('click', ()=>{ idx++; nextQuestion(); });
$('#restartBtn').addEventListener('click', ()=>{ if(confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) resetAll(); });
$('#againBtn').addEventListener('click', resetAll);
$('#saveScoreBtn').addEventListener('click', pushScore);
$('#clearRankBtn').addEventListener('click', ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ saveRank([]); renderRanking(); }});

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–°ï¼ˆ1ç§’æ¯ï¼‰
setInterval(()=>{ if($('#quizCard')&&!$('#quizCard').classList.contains('hidden')) renderStats(); }, 1000);

// èµ·å‹•
resetAll();
</script></body>
</html>
