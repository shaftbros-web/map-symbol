<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>åœ°å›³è¨˜å·4æŠãƒ‰ãƒªãƒ« â€” SVGç‰ˆï¼ˆå…¨å•æ­£è§£ã¾ã§ï¼‰</title>
  <meta name="description" content="ä¸­å­¦ç”Ÿå‘ã‘ï¼šåœ°å›³è¨˜å·ã‚’4æŠã§è¦šãˆã‚‹ã‚¹ãƒãƒ›ç”¨WEBãƒ‰ãƒªãƒ«ã€‚SVGèª­ã¿è¾¼ã¿ã€èª¤ç­”å¾©ç¿’ã€å…¨å•æ­£è§£ã¾ã§ç¶šè¡Œã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œã€‚" />
  <style>
    :root{--bg:#0b0f14;--panel:#0f1520;--ink:#e6edf3;--muted:#9aa4b2;--ok:#16a34a;--ng:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    body{min-height:100dvh;display:flex;flex-direction:column}
    header,footer{background:var(--panel);padding:8px 10px;font-size:14px;text-align:center}
    main{flex:1;display:grid;place-items:center;padding:10px}
    .wrap{width:100%;max-width:620px;display:grid;gap:10px}

    /* è¨˜å·ãƒ‘ãƒãƒ«ï¼ˆç™½èƒŒæ™¯ã§è¦–èªæ€§ï¼‰ */
    .symbolBox{
      position:relative;
      display:grid;place-items:center;
      height:clamp(180px,36vh,320px);
      border:1px solid #cbd5e1;border-radius:16px;
      background:#fff;color:#111827;
      overflow:hidden;
    }
    .symbolBox .fallback{font-size:clamp(70px,14vh,120px);line-height:1}
    .imgSym{width:clamp(140px,34vh,260px);height:clamp(140px,34vh,260px);object-fit:contain}

    .bar{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .tag{font-size:11px;color:#a3e635;background:#1a2b0f;border:1px solid #2c4a17;padding:2px 8px;border-radius:999px}

    .choices{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .choices button{
      padding:12px;border:none;border-radius:12px;background:#1f2937;color:var(--ink);
      font-size:16px;text-align:left;cursor:pointer
    }
    .choices button.correct{background:#14532d}
    .choices button.wrong{background:#7f1d1d}
    .choices button:disabled{opacity:.85;cursor:default}

    /* è¶…å¤§å‹ã®åˆ¤å®šè¡¨ç¤ºï¼ˆâ—¯/Ã—ï¼‰ï¼šä¸­å¤®ä»˜è¿‘ãƒ»ãƒœã‚¿ãƒ³ã«ã‹ã¶ã‚‰ãªã„ï¼ˆä¸Šå¯„ã‚Šï¼‰ */
    #judge{
      position:fixed;
      left:50%;
      top:32%;              /* â† ãƒœã‚¿ãƒ³ã«ã‹ã¶ã‚‰ãªã„ã‚ˆã†ã«ã‚„ã‚„ä¸Š */
      transform:translate(-50%,-50%);
      font-size:clamp(64px,12vh,120px);  /* ã‚‚ã£ã¨å¤§ããï¼ */
      font-weight:900;
      color:#111;           /* ä¸‹åœ°ç™½ã§ç¨‹ã‚ˆãè¦‹ãˆã‚‹æ¿ƒã‚°ãƒ¬ãƒ¼ */
      text-shadow:
        0 0 2px #fff,
        0 0 12px rgba(255,255,255,.9),
        0 6px 18px rgba(0,0,0,.35);
      letter-spacing:.08em;
      opacity:0;
      pointer-events:none;
      z-index:9999;
      transition:opacity .25s ease-out;
    }
    #judge.ok { color: var(--ok); }
    #judge.ng { color: var(--ng); }
    #judge.show { opacity:1; }

    /* è¨­å®šãƒœã‚¿ãƒ³ï¼†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 12px;border:none;border-radius:10px;background:#1f2937;color:#e6edf3}
    .btn.warn{color:#fca5a5;border:1px solid #7f1d1d}
    .btn.ghost{background:#0b1220;border:1px solid #1f2937}

    #settings{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:9998}
    #settings.show{display:grid}
    .sheet{background:#0f172a;border:1px solid #1f2937;border-radius:16px;min-width:min(94vw,520px);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .row label{display:flex;gap:8px;align-items:center;font-size:14px;color:#e5e7eb;background:#111827;border:1px solid #1f2937;border-radius:999px;padding:8px 12px}
    .row input{accent-color:#60a5fa;width:18px;height:18px}
    .sheet .hd{font-weight:700;margin:0 0 6px 2px}

    /* ã‚¯ãƒªã‚¢ç”»é¢ */
    #finish{position:fixed;inset:0;display:none;place-items:center;z-index:10000;background:rgba(0,0,0,.6)}
    #finish.show{display:grid}
    .finishCard{background:#0f172a;border:1px solid #1f2937;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.4);padding:22px;min-width:min(94vw,560px);text-align:center}
    .big{font-size:clamp(28px,4.6vh,40px);margin:6px 0}
    .rankLine{font-size:clamp(40px,7vh,56px);font-weight:900;margin:4px 0}
    .meta{color:var(--muted);margin:6px 0 16px}
    .finishBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .finishBtns button{padding:12px 14px;border:none;border-radius:12px;background:#1f2937;color:#e6edf3}

    details#rank{max-width:620px;margin:0 auto;padding:8px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left}
    th{color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <header>åœ°å›³è¨˜å·4æŠãƒ‰ãƒªãƒ« â€” SVGç‰ˆï¼ˆå…¨å•æ­£è§£ã¾ã§ï¼‰</header>
  <main>
    <div class="wrap">
      <div class="symbolBox">
        <img id="qImg" class="imgSym" alt="åœ°å›³è¨˜å·" />
        <div id="fallback" class="fallback" hidden>ï¼Ÿ</div>
      </div>

      <div class="bar">
        <div><span id="qCounter">â€”</span> <span id="hint" class="tag" hidden>å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</span></div>
        <div>é€²è¡Œ <b id="progress">0/0</b> ï¼ æ­£è§£ç‡ <b id="acc">0%</b> ï¼ æ™‚é–“ <b id="time">00:00</b></div>
      </div>

      <div id="choices" class="choices"></div>
      <div id="feedback" hidden></div>

      <div class="controls">
        <div style="display:flex;gap:10px">
          <button id="restartBtn" class="btn warn">æœ€åˆã‹ã‚‰</button>
          <button id="preloadBtn" class="btn">ç”»åƒå†èª­è¾¼</button>
        </div>
        <button id="settingsBtn" class="btn ghost">âš™ è¨­å®š</button>
      </div>
    </div>
  </main>

  <!-- åˆ¤å®šè¡¨ç¤ºï¼ˆå¤§ãã„â—¯Ã—ï¼‰ -->
  <div id="judge" aria-hidden="true">â—¯</div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ2ã‚¹ã‚¤ãƒƒãƒã®ã¿ï¼‰ -->
  <div id="settings" role="dialog" aria-modal="true" aria-labelledby="stHd">
    <div class="sheet">
      <div class="hd" id="stHd">è¨­å®š</div>
      <div class="row">
        <label><input type="checkbox" id="optRequireCorrect"> æ­£è§£ã™ã‚‹ã¾ã§é€²ã¾ãªã„</label>
        <label><input type="checkbox" id="optReview" checked> å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚ã‚Š</label>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="closeSettings" class="btn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ã‚¯ãƒªã‚¢ç”»é¢ -->
  <div id="finish">
    <div class="finishCard">
      <div class="big">ğŸ‰ å…¨å•æ­£è§£ï¼ã‚¯ãƒªã‚¢</div>
      <div id="finRank" class="rankLine">1ä½</div>
      <div class="big">æ­£è§£ç‡ <b id="finAcc">100%</b> ï¼ æ™‚é–“ <b id="finTime">00:00</b></div>
      <div id="finGrade" class="rankLine">ğŸ‘‘ ç¥</div>
      <div class="meta">ï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¨˜éŒ²ã—ã¾ã—ãŸï¼‰</div>
      <div class="finishBtns">
        <button id="againBtn" class="btn">ã‚‚ã†ä¸€åº¦</button>
        <button id="showRankBtn" class="btn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
      </div>
    </div>
  </div>

  <details id="rank">
    <summary>ğŸ† ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæ—¥æ™‚ãƒ»æ­£è§£ç‡ãƒ»æ™‚é–“ã‚’è‡ªå‹•è¨˜éŒ²ï¼‰</summary>
    <table>
      <thead><tr><th>#</th><th>æ—¥æ™‚</th><th>æ­£è§£ç‡</th><th>æ™‚é–“</th></tr></thead>
      <tbody id="rankBody"></tbody>
    </table>
    <div style="margin-top:8px">
      <button id="clearRankBtn" class="btn warn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
    </div>
  </details>

  <footer>Â© 2025 Map Symbols Drill â€” SVGå¯¾å¿œ</footer>

<script>
"use strict";

/* ================== ãƒ‡ãƒ¼ã‚¿ï¼ˆSVGç”»åƒãƒ»32ç¨®ï¼‰ ================== */
const SYMBOLS = [
  // 1 åˆ—ç›®ï¼ˆå¸‚å½¹æ‰€ã€œå›³æ›¸é¤¨ï¼‰
  {id:'cityhall',      name:'å¸‚å½¹æ‰€',           file:'cityhall.svg',       fallback:'å¸‚'},
  {id:'townhall',      name:'ç”ºãƒ»æ‘å½¹å ´',       file:'townhall.svg',       fallback:'ç”º'},
  {id:'government',    name:'å®˜å…¬ç½²',           file:'government.svg',     fallback:'å…¬'},
  {id:'police',        name:'è­¦å¯Ÿç½²',           file:'police.svg',         fallback:'äº¤'},
  {id:'koban',         name:'äº¤ç•ª',             file:'koban.svg',          fallback:'äº¤'},
  {id:'postoffice',    name:'éƒµä¾¿å±€',           file:'postoffice.svg',     fallback:'ã€’'},
  {id:'firestation',   name:'æ¶ˆé˜²ç½²',           file:'firestation.svg',    fallback:'æ¶ˆ'},
  {id:'school',        name:'å°ãƒ»ä¸­å­¦æ ¡',       file:'school.svg',         fallback:'æ–‡'},
  {id:'highschool',    name:'é«˜ç­‰å­¦æ ¡',         file:'highschool.svg',     fallback:'é«˜'},
  {id:'hospital',      name:'ç—…é™¢',             file:'hospital.svg',       fallback:'H'},
  {id:'healthcenter',  name:'ä¿å¥æ‰€',           file:'healthcenter.svg',   fallback:'å¥'},
  {id:'temple',        name:'å¯ºé™¢',             file:'temple.svg',         fallback:'å'},
  {id:'shrine',        name:'ç¥ç¤¾',             file:'shrine.svg',         fallback:'â›©'},
  {id:'factory',       name:'å·¥å ´',             file:'factory.svg',        fallback:'å·¥'},
  {id:'power_substation', name:'ç™ºé›»æ‰€ãƒ»å¤‰é›»æ‰€', file:'power_substation.svg', fallback:'é›»'},
  {id:'library',       name:'å›³æ›¸é¤¨',           file:'library.svg',        fallback:'å›³'},

  // 2 åˆ—ç›®ï¼ˆæ°´ç”°ã€œå¸‚è¡—åœ°ï¼‰
  {id:'paddy',         name:'æ°´ç”°',             file:'paddy.svg',          fallback:'ç”°'},
  {id:'field',         name:'ç•‘',               file:'field.svg',          fallback:'ç•‘'},
  {id:'orchard',       name:'æœæ¨¹åœ’',           file:'orchard.svg',        fallback:'æœ'},
  {id:'teafield',      name:'èŒ¶ç•‘',             file:'teafield.svg',       fallback:'èŒ¶'},
  {id:'mulberry',      name:'æ¡‘ç•‘',             file:'mulberry.svg',       fallback:'æ¡‘'},
  {id:'broadleaf',     name:'åºƒè‘‰æ¨¹æ—',         file:'broadleaf.svg',      fallback:'åºƒ'},
  {id:'conifer',       name:'é‡è‘‰æ¨¹æ—',         file:'conifer.svg',        fallback:'é‡'},
  {id:'wasteland',     name:'è’åœ°',             file:'wasteland.svg',      fallback:'è’'},
  {id:'triangulation', name:'ä¸‰è§’ç‚¹',           file:'triangulation.svg',  fallback:'â–³'},
  {id:'benchmark',     name:'æ°´æº–ç‚¹',           file:'benchmark.svg',      fallback:'åŸº'},
  {id:'museum',        name:'åšç‰©é¤¨',           file:'museum.svg',         fallback:'åš'},
  {id:'nursing_home',  name:'è€äººãƒ›ãƒ¼ãƒ ',       file:'nursing_home.svg',   fallback:'è€'},
  {id:'castle_ruins',  name:'åŸè·¡',             file:'castle_ruins.svg',   fallback:'åŸ'},
  {id:'lighthouse',    name:'ç¯å°',             file:'lighthouse.svg',     fallback:'ç¯'},
  {id:'buildings',     name:'å»ºç‰©ãƒ»ä½å®…',       file:'buildings.svg',      fallback:'å»º'},
  {id:'urban',         name:'å¸‚è¡—åœ°',           file:'urban.svg',          fallback:'å¸‚'},
];

const IMG_BASE = 'symbols/'; // ç›¸å¯¾ãƒ‘ã‚¹
const ALL_NAMES = SYMBOLS.map(s=>s.name);

// ===== util =====
const $ = s => document.querySelector(s);
const shuffle = a => a.map(x=>[Math.random(),x]).sort((m,n)=>m[0]-n[0]).map(x=>x[1]);
const two = n => String(n).padStart(2,"0");
const fmtTime = ms => { const t=Math.round(ms/1000); const m=Math.floor(t/60), s=t%60; return `${two(m)}:${two(s)}`; };

// ===== ranking (æ—¥æ™‚ã®ã¿) =====
const LS_KEY = "mapdrill_rank_svg_v1";
const OPTS_KEY = "mapdrill_opts_v2"; // è¨­å®šä¿å­˜
const loadRank = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } };
const saveRank = (list) => localStorage.setItem(LS_KEY, JSON.stringify(list));
function pushRankWithReturn(acc,ms){
  const list = loadRank();
  const entry = {at:Date.now(), acc, ms};
  list.push(entry);
  list.sort((a,b)=> (b.acc-a.acc) || (a.ms-b.ms));
  const rankIndex = list.indexOf(entry); // 0-based
  saveRank(list.slice(0,100));
  renderRank();
  return {rank: rankIndex+1, total: list.length, entry};
}
function renderRank(){
  const tb=$("#rankBody"); if(!tb) return;
  tb.innerHTML="";
  loadRank().forEach((r,i)=>{
    const d=new Date(r.at);
    const when = `${d.getFullYear()}/${two(d.getMonth()+1)}/${two(d.getDate())} ${two(d.getHours())}:${two(d.getMinutes())}`;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${when}</td><td>${Math.round(r.acc*100)}%</td><td>${fmtTime(r.ms)}</td>`;
    tb.appendChild(tr);
  });
}

// ===== ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ­£è§£ä¸è¦=OFFã€å¾©ç¿’ã‚ã‚Š=ONï¼‰ =====
let requireCorrect = false;
let reviewEnabled = true;
function loadOpts(){
  try{
    const o = JSON.parse(localStorage.getItem(OPTS_KEY)||"{}");
    if(typeof o.requireCorrect === 'boolean') requireCorrect = o.requireCorrect;
    if(typeof o.reviewEnabled === 'boolean') reviewEnabled = o.reviewEnabled;
  }catch{}
  $("#optRequireCorrect").checked = requireCorrect;
  $("#optReview").checked = reviewEnabled;
}
function saveOpts(){
  localStorage.setItem(OPTS_KEY, JSON.stringify({requireCorrect, reviewEnabled}));
}
$("#optRequireCorrect")?.addEventListener('change', (e)=>{ requireCorrect = e.target.checked; saveOpts(); });
$("#optReview")?.addEventListener('change', (e)=>{ reviewEnabled = e.target.checked; saveOpts(); });

// ===== çŠ¶æ…‹ =====
let queue=[], idx=0, attempts=0, correctClicks=0, startedAt=0;
let wrongSet = new Set();
let stage = 'first'; // 'first' or 'review'

// ===== ç”»åƒ =====
function preloadImages(){ SYMBOLS.forEach(s=>{ const img=new Image(); img.src=IMG_BASE+s.file; }); }
function renderSymbol(sym){
  const img=$("#qImg"), fb=$("#fallback");
  fb.hidden=true; img.hidden=false; img.alt=sym.name;
  img.src = IMG_BASE + sym.file + `?v=${Date.now()}`;
  img.onerror = ()=>{ img.hidden=true; fb.textContent=(sym.fallback||'ï¼Ÿ')+`ï¼ˆç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼š${IMG_BASE}${sym.file}ï¼‰`; fb.hidden=false; };
}

// ===== å‡ºé¡Œ =====
function start(){
  queue = shuffle([...SYMBOLS]); // åˆå›ã‚»ãƒƒãƒˆ
  idx=0; attempts=0; correctClicks=0; startedAt=performance.now();
  wrongSet.clear(); stage='first';
  $("#hint").hidden = true;
  next();
}

function pickChoices(answerName){
  const pool = ALL_NAMES.filter(n=>n!==answerName);
  return shuffle([answerName, ...shuffle(pool).slice(0,3)]);
}

function next(){
  if(idx >= queue.length){
    if(reviewEnabled && stage==='first' && wrongSet.size>0){
      // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼šèª¤ç­”ã®ã¿
      queue = shuffle(SYMBOLS.filter(s=>wrongSet.has(s.id)));
      wrongSet.clear(); idx = 0; stage = 'review';
      $("#hint").hidden = false;
    }else if(reviewEnabled && stage==='review' && wrongSet.size>0){
      // å¾©ç¿’ä¸­ã«ã¾ãŸé–“é•ãˆãŸã‚‚ã®ãŒã‚ã‚Œã°ã€ã•ã‚‰ã«å¾©ç¿’
      queue = shuffle(SYMBOLS.filter(s=>wrongSet.has(s.id)));
      wrongSet.clear(); idx = 0;
    }else{
      return finish();
    }
  }

  const sym = queue[idx];
  renderSymbol(sym);

  $("#qCounter").textContent = `å•é¡Œ ${idx+1} / ${queue.length}`;

  const names = pickChoices(sym.name);
  const wrap = $("#choices"); wrap.innerHTML = "";
  names.forEach(n=>{
    const b=document.createElement("button");
    b.textContent=n;
    b.addEventListener('click', (e)=>{ e.stopPropagation(); answer(n, sym, b); }, {passive:true});
    wrap.appendChild(b);
  });

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  $("#progress").textContent = `${idx+1}/${queue.length}`;
  $("#acc").textContent = attempts ? `${Math.round((correctClicks/attempts)*100)}%` : "0%";
}

function disableWrongButton(btn){ btn.disabled = true; btn.classList.add('wrong'); }
function markCorrect(btn){ btn.classList.add('correct'); }

/* è¶…å¤§å‹ã®â—¯/Ã—ã‚’ä¸­å¤®ä»˜è¿‘ã«çŸ­æ™‚é–“è¡¨ç¤ºï¼ˆç´„1.0ç§’ï¼‰ */
function showJudge(isOK){
  const j = $("#judge");
  j.textContent = isOK ? "â—¯" : "Ã—";
  j.classList.remove('ok','ng','show');
  j.classList.add(isOK ? 'ok' : 'ng');
  // reflow ã§ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³å†å®Ÿè¡Œ
  void j.offsetWidth;
  j.classList.add('show');
  // 1ç§’å¾Œã«è‡ªå‹•ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  setTimeout(()=> j.classList.remove('show'), 1000);
}

function answer(sel, sym, btnEl){
  attempts++;
  const ok = (sel === sym.name);

  // ç«¯æœ«ãƒã‚¤ãƒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œï¼‰
  try{
    if (navigator.vibrate) {
      navigator.vibrate(ok ? 28 : [14,60,18]);
    }
  }catch(e){}

  if (ok) {
    correctClicks++;
    markCorrect(btnEl);
    document.querySelectorAll('#choices button').forEach(b=>b.disabled=true);
    showJudge(true);
    setTimeout(()=>{ idx++; next(); }, 420);
  } else {
    if(reviewEnabled) wrongSet.add(sym.id);
    disableWrongButton(btnEl);
    showJudge(false);
    if(!requireCorrect){
      // æ­£è§£ä¸è¦ãƒ¢ãƒ¼ãƒ‰ï¼šä¸æ­£è§£ã§ã‚‚æ¬¡ã¸
      document.querySelectorAll('#choices button').forEach(b=>b.disabled=true);
      setTimeout(()=>{ idx++; next(); }, 500);
    }
    // æ­£è§£å¿…é ˆãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã“ã“ã§æ­¢ã‚ã¦å†æŒ‘æˆ¦
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  $("#acc").textContent = attempts ? `${Math.round((correctClicks/attempts)*100)}%` : "0%";
}

// ===== ã‚¯ãƒªã‚¢å‡¦ç† =====
function finish(){
  const ms = performance.now()-startedAt;
  const acc = attempts? (correctClicks/attempts) : 0;
  const res = pushRankWithReturn(acc, ms);

  $("#finRank").textContent = `${res.rank}ä½`;
  const pct = Math.round(acc*100);
  $("#finAcc").textContent = `${pct}%`;
  $("#finTime").textContent = fmtTime(ms);
  $("#finGrade").textContent =
    (pct===100)?'ğŸ‘‘ ç¥':(pct>=80?'ğŸ¦ ç‹è€…':(pct>=60?'ğŸ´ äººé–“':(pct>=50?'ğŸ¢ äº€':'ğŸ› è™«')));
  $("#finish").classList.add("show");
}

// ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
$("#restartBtn").addEventListener('click', ()=>{
  if(confirm('æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')){ $("#finish").classList.remove('show'); start(); }
});
$("#againBtn").addEventListener('click', ()=>{ $("#finish").classList.remove('show'); start(); });
$("#showRankBtn").addEventListener('click', ()=>{ $("#finish").classList.remove('show'); document.querySelector('#rank').open = true; });
$("#clearRankBtn").addEventListener('click', ()=>{
  if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(LS_KEY); renderRank(); }
});
$("#preloadBtn").addEventListener('click', preloadImages);

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
$("#settingsBtn").addEventListener('click', ()=> $("#settings").classList.add('show'));
$("#closeSettings").addEventListener('click', ()=> $("#settings").classList.remove('show'));
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') $("#settings").classList.remove('show'); });

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆ1ç§’æ¯ï¼‰
setInterval(()=>{ 
  const playing = !$("#finish").classList.contains('show');
  if(playing){ $("#time").textContent = fmtTime(performance.now()-startedAt); }
}, 1000);

// èµ·å‹•
document.addEventListener("DOMContentLoaded", ()=>{
  renderRank(); preloadImages(); loadOpts(); start();
});
</script>
</body>
</html>
