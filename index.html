<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>地図記号4択ドリル — SVG版（全問正解まで）</title>
  <meta name="description" content="中学生向け：地図記号を4択で覚えるスマホ用WEBドリル。SVG読み込み、誤答復習、全問正解まで続行、ローカルランキング対応。" />
  <style>
    :root{--bg:#0b0f14;--panel:#0f1520;--ink:#e6edf3;--muted:#9aa4b2;--ok:#16a34a;--ng:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    body{min-height:100dvh;display:flex;flex-direction:column}
    header,footer{background:var(--panel);padding:8px 10px;font-size:14px;text-align:center}
    main{flex:1;display:grid;place-items:center;padding:10px}
    .wrap{width:100%;max-width:620px;display:grid;gap:10px}

    /* 記号パネル（白背景で視認性） */
    .symbolBox{
      position:relative;
      display:grid;place-items:center;
      height:clamp(180px,36vh,320px);
      border:1px solid #cbd5e1;border-radius:16px;
      background:#fff;color:#111827;
      overflow:hidden;
    }
    .symbolBox .fallback{font-size:clamp(70px,14vh,120px);line-height:1}
    .imgSym{width:clamp(140px,34vh,260px);height:clamp(140px,34vh,260px);object-fit:contain}

    .bar{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .tag{font-size:11px;color:#a3e635;background:#1a2b0f;border:1px solid #2c4a17;padding:2px 8px;border-radius:999px}

    .choices{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .choices button{
      padding:12px;border:none;border-radius:12px;background:#1f2937;color:var(--ink);
      font-size:16px;text-align:left;cursor:pointer
    }
    .choices button.correct{background:#14532d}
    .choices button.wrong{background:#7f1d1d}
    .choices button:disabled{opacity:.85;cursor:default}

    /* 超大型の判定表示（◯/×）：中央付近・ボタンにかぶらない（上寄り） */
    #judge{
      position:fixed;
      left:50%;
      top:32%;              /* ← ボタンにかぶらないようにやや上 */
      transform:translate(-50%,-50%);
      font-size:clamp(64px,12vh,120px);  /* もっと大きく！ */
      font-weight:900;
      color:#111;           /* 下地白で程よく見える濃グレー */
      text-shadow:
        0 0 2px #fff,
        0 0 12px rgba(255,255,255,.9),
        0 6px 18px rgba(0,0,0,.35);
      letter-spacing:.08em;
      opacity:0;
      pointer-events:none;
      z-index:9999;
      transition:opacity .25s ease-out;
    }
    #judge.ok { color: var(--ok); }
    #judge.ng { color: var(--ng); }
    #judge.show { opacity:1; }

    /* 設定ボタン＆モーダル */
    .controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 12px;border:none;border-radius:10px;background:#1f2937;color:#e6edf3}
    .btn.warn{color:#fca5a5;border:1px solid #7f1d1d}
    .btn.ghost{background:#0b1220;border:1px solid #1f2937}

    #settings{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:9998}
    #settings.show{display:grid}
    .sheet{background:#0f172a;border:1px solid #1f2937;border-radius:16px;min-width:min(94vw,520px);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .row label{display:flex;gap:8px;align-items:center;font-size:14px;color:#e5e7eb;background:#111827;border:1px solid #1f2937;border-radius:999px;padding:8px 12px}
    .row input{accent-color:#60a5fa;width:18px;height:18px}
    .sheet .hd{font-weight:700;margin:0 0 6px 2px}

    /* クリア画面 */
    #finish{position:fixed;inset:0;display:none;place-items:center;z-index:10000;background:rgba(0,0,0,.6)}
    #finish.show{display:grid}
    .finishCard{background:#0f172a;border:1px solid #1f2937;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.4);padding:22px;min-width:min(94vw,560px);text-align:center}
    .big{font-size:clamp(28px,4.6vh,40px);margin:6px 0}
    .rankLine{font-size:clamp(40px,7vh,56px);font-weight:900;margin:4px 0}
    .meta{color:var(--muted);margin:6px 0 16px}
    .finishBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .finishBtns button{padding:12px 14px;border:none;border-radius:12px;background:#1f2937;color:#e6edf3}

    details#rank{max-width:620px;margin:0 auto;padding:8px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left}
    th{color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <header>地図記号4択ドリル — SVG版（全問正解まで）</header>
  <main>
    <div class="wrap">
      <div class="symbolBox">
        <img id="qImg" class="imgSym" alt="地図記号" />
        <div id="fallback" class="fallback" hidden>？</div>
      </div>

      <div class="bar">
        <div><span id="qCounter">—</span> <span id="hint" class="tag" hidden>復習モード</span></div>
        <div>進行 <b id="progress">0/0</b> ／ 正解率 <b id="acc">0%</b> ／ 時間 <b id="time">00:00</b></div>
      </div>

      <div id="choices" class="choices"></div>
      <div id="feedback" hidden></div>

      <div class="controls">
        <div style="display:flex;gap:10px">
          <button id="restartBtn" class="btn warn">最初から</button>
          <button id="preloadBtn" class="btn">画像再読込</button>
        </div>
        <button id="settingsBtn" class="btn ghost">⚙ 設定</button>
      </div>
    </div>
  </main>

  <!-- 判定表示（大きい◯×） -->
  <div id="judge" aria-hidden="true">◯</div>

  <!-- 設定モーダル（2スイッチのみ） -->
  <div id="settings" role="dialog" aria-modal="true" aria-labelledby="stHd">
    <div class="sheet">
      <div class="hd" id="stHd">設定</div>
      <div class="row">
        <label><input type="checkbox" id="optRequireCorrect"> 正解するまで進まない</label>
        <label><input type="checkbox" id="optReview" checked> 復習モードあり</label>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="closeSettings" class="btn">閉じる</button>
      </div>
    </div>
  </div>

  <!-- クリア画面 -->
  <div id="finish">
    <div class="finishCard">
      <div class="big">🎉 全問正解！クリア</div>
      <div id="finRank" class="rankLine">1位</div>
      <div class="big">正解率 <b id="finAcc">100%</b> ／ 時間 <b id="finTime">00:00</b></div>
      <div id="finGrade" class="rankLine">👑 神</div>
      <div class="meta">（端末ローカルのランキングに記録しました）</div>
      <div class="finishBtns">
        <button id="againBtn" class="btn">もう一度</button>
        <button id="showRankBtn" class="btn">ランキングを見る</button>
      </div>
    </div>
  </div>

  <details id="rank">
    <summary>🏆 ローカルランキング（日時・正解率・時間を自動記録）</summary>
    <table>
      <thead><tr><th>#</th><th>日時</th><th>正解率</th><th>時間</th></tr></thead>
      <tbody id="rankBody"></tbody>
    </table>
    <div style="margin-top:8px">
      <button id="clearRankBtn" class="btn warn">ランキングを消去</button>
    </div>
  </details>

  <footer>© 2025 Map Symbols Drill — SVG対応</footer>

<script>
"use strict";

/* ================== データ（SVG画像・32種） ================== */
const SYMBOLS = [
  // 1 列目（市役所〜図書館）
  {id:'cityhall',      name:'市役所',           file:'cityhall.svg',       fallback:'市'},
  {id:'townhall',      name:'町・村役場',       file:'townhall.svg',       fallback:'町'},
  {id:'government',    name:'官公署',           file:'government.svg',     fallback:'公'},
  {id:'police',        name:'警察署',           file:'police.svg',         fallback:'交'},
  {id:'koban',         name:'交番',             file:'koban.svg',          fallback:'交'},
  {id:'postoffice',    name:'郵便局',           file:'postoffice.svg',     fallback:'〒'},
  {id:'firestation',   name:'消防署',           file:'firestation.svg',    fallback:'消'},
  {id:'school',        name:'小・中学校',       file:'school.svg',         fallback:'文'},
  {id:'highschool',    name:'高等学校',         file:'highschool.svg',     fallback:'高'},
  {id:'hospital',      name:'病院',             file:'hospital.svg',       fallback:'H'},
  {id:'healthcenter',  name:'保健所',           file:'healthcenter.svg',   fallback:'健'},
  {id:'temple',        name:'寺院',             file:'temple.svg',         fallback:'卍'},
  {id:'shrine',        name:'神社',             file:'shrine.svg',         fallback:'⛩'},
  {id:'factory',       name:'工場',             file:'factory.svg',        fallback:'工'},
  {id:'power_substation', name:'発電所・変電所', file:'power_substation.svg', fallback:'電'},
  {id:'library',       name:'図書館',           file:'library.svg',        fallback:'図'},

  // 2 列目（水田〜市街地）
  {id:'paddy',         name:'水田',             file:'paddy.svg',          fallback:'田'},
  {id:'field',         name:'畑',               file:'field.svg',          fallback:'畑'},
  {id:'orchard',       name:'果樹園',           file:'orchard.svg',        fallback:'果'},
  {id:'teafield',      name:'茶畑',             file:'teafield.svg',       fallback:'茶'},
  {id:'mulberry',      name:'桑畑',             file:'mulberry.svg',       fallback:'桑'},
  {id:'broadleaf',     name:'広葉樹林',         file:'broadleaf.svg',      fallback:'広'},
  {id:'conifer',       name:'針葉樹林',         file:'conifer.svg',        fallback:'針'},
  {id:'wasteland',     name:'荒地',             file:'wasteland.svg',      fallback:'荒'},
  {id:'triangulation', name:'三角点',           file:'triangulation.svg',  fallback:'△'},
  {id:'benchmark',     name:'水準点',           file:'benchmark.svg',      fallback:'基'},
  {id:'museum',        name:'博物館',           file:'museum.svg',         fallback:'博'},
  {id:'nursing_home',  name:'老人ホーム',       file:'nursing_home.svg',   fallback:'老'},
  {id:'castle_ruins',  name:'城跡',             file:'castle_ruins.svg',   fallback:'城'},
  {id:'lighthouse',    name:'灯台',             file:'lighthouse.svg',     fallback:'灯'},
  {id:'buildings',     name:'建物・住宅',       file:'buildings.svg',      fallback:'建'},
  {id:'urban',         name:'市街地',           file:'urban.svg',          fallback:'市'},
];

const IMG_BASE = 'symbols/'; // 相対パス
const ALL_NAMES = SYMBOLS.map(s=>s.name);

// ===== util =====
const $ = s => document.querySelector(s);
const shuffle = a => a.map(x=>[Math.random(),x]).sort((m,n)=>m[0]-n[0]).map(x=>x[1]);
const two = n => String(n).padStart(2,"0");
const fmtTime = ms => { const t=Math.round(ms/1000); const m=Math.floor(t/60), s=t%60; return `${two(m)}:${two(s)}`; };

// ===== ranking (日時のみ) =====
const LS_KEY = "mapdrill_rank_svg_v1";
const OPTS_KEY = "mapdrill_opts_v2"; // 設定保存
const loadRank = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } };
const saveRank = (list) => localStorage.setItem(LS_KEY, JSON.stringify(list));
function pushRankWithReturn(acc,ms){
  const list = loadRank();
  const entry = {at:Date.now(), acc, ms};
  list.push(entry);
  list.sort((a,b)=> (b.acc-a.acc) || (a.ms-b.ms));
  const rankIndex = list.indexOf(entry); // 0-based
  saveRank(list.slice(0,100));
  renderRank();
  return {rank: rankIndex+1, total: list.length, entry};
}
function renderRank(){
  const tb=$("#rankBody"); if(!tb) return;
  tb.innerHTML="";
  loadRank().forEach((r,i)=>{
    const d=new Date(r.at);
    const when = `${d.getFullYear()}/${two(d.getMonth()+1)}/${two(d.getDate())} ${two(d.getHours())}:${two(d.getMinutes())}`;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${when}</td><td>${Math.round(r.acc*100)}%</td><td>${fmtTime(r.ms)}</td>`;
    tb.appendChild(tr);
  });
}

// ===== オプション（デフォルト：正解不要=OFF、復習あり=ON） =====
let requireCorrect = false;
let reviewEnabled = true;
function loadOpts(){
  try{
    const o = JSON.parse(localStorage.getItem(OPTS_KEY)||"{}");
    if(typeof o.requireCorrect === 'boolean') requireCorrect = o.requireCorrect;
    if(typeof o.reviewEnabled === 'boolean') reviewEnabled = o.reviewEnabled;
  }catch{}
  $("#optRequireCorrect").checked = requireCorrect;
  $("#optReview").checked = reviewEnabled;
}
function saveOpts(){
  localStorage.setItem(OPTS_KEY, JSON.stringify({requireCorrect, reviewEnabled}));
}
$("#optRequireCorrect")?.addEventListener('change', (e)=>{ requireCorrect = e.target.checked; saveOpts(); });
$("#optReview")?.addEventListener('change', (e)=>{ reviewEnabled = e.target.checked; saveOpts(); });

// ===== 状態 =====
let queue=[], idx=0, attempts=0, correctClicks=0, startedAt=0;
let wrongSet = new Set();
let stage = 'first'; // 'first' or 'review'

// ===== 画像 =====
function preloadImages(){ SYMBOLS.forEach(s=>{ const img=new Image(); img.src=IMG_BASE+s.file; }); }
function renderSymbol(sym){
  const img=$("#qImg"), fb=$("#fallback");
  fb.hidden=true; img.hidden=false; img.alt=sym.name;
  img.src = IMG_BASE + sym.file + `?v=${Date.now()}`;
  img.onerror = ()=>{ img.hidden=true; fb.textContent=(sym.fallback||'？')+`（画像が読み込めません：${IMG_BASE}${sym.file}）`; fb.hidden=false; };
}

// ===== 出題 =====
function start(){
  queue = shuffle([...SYMBOLS]); // 初回セット
  idx=0; attempts=0; correctClicks=0; startedAt=performance.now();
  wrongSet.clear(); stage='first';
  $("#hint").hidden = true;
  next();
}

function pickChoices(answerName){
  const pool = ALL_NAMES.filter(n=>n!==answerName);
  return shuffle([answerName, ...shuffle(pool).slice(0,3)]);
}

function next(){
  if(idx >= queue.length){
    if(reviewEnabled && stage==='first' && wrongSet.size>0){
      // 復習モード開始：誤答のみ
      queue = shuffle(SYMBOLS.filter(s=>wrongSet.has(s.id)));
      wrongSet.clear(); idx = 0; stage = 'review';
      $("#hint").hidden = false;
    }else if(reviewEnabled && stage==='review' && wrongSet.size>0){
      // 復習中にまた間違えたものがあれば、さらに復習
      queue = shuffle(SYMBOLS.filter(s=>wrongSet.has(s.id)));
      wrongSet.clear(); idx = 0;
    }else{
      return finish();
    }
  }

  const sym = queue[idx];
  renderSymbol(sym);

  $("#qCounter").textContent = `問題 ${idx+1} / ${queue.length}`;

  const names = pickChoices(sym.name);
  const wrap = $("#choices"); wrap.innerHTML = "";
  names.forEach(n=>{
    const b=document.createElement("button");
    b.textContent=n;
    b.addEventListener('click', (e)=>{ e.stopPropagation(); answer(n, sym, b); }, {passive:true});
    wrap.appendChild(b);
  });

  // ステータス更新
  $("#progress").textContent = `${idx+1}/${queue.length}`;
  $("#acc").textContent = attempts ? `${Math.round((correctClicks/attempts)*100)}%` : "0%";
}

function disableWrongButton(btn){ btn.disabled = true; btn.classList.add('wrong'); }
function markCorrect(btn){ btn.classList.add('correct'); }

/* 超大型の◯/×を中央付近に短時間表示（約1.0秒） */
function showJudge(isOK){
  const j = $("#judge");
  j.textContent = isOK ? "◯" : "×";
  j.classList.remove('ok','ng','show');
  j.classList.add(isOK ? 'ok' : 'ng');
  // reflow でトランジション再実行
  void j.offsetWidth;
  j.classList.add('show');
  // 1秒後に自動フェードアウト
  setTimeout(()=> j.classList.remove('show'), 1000);
}

function answer(sel, sym, btnEl){
  attempts++;
  const ok = (sel === sym.name);

  // 端末バイブ（ユーザー操作直後）
  try{
    if (navigator.vibrate) {
      navigator.vibrate(ok ? 28 : [14,60,18]);
    }
  }catch(e){}

  if (ok) {
    correctClicks++;
    markCorrect(btnEl);
    document.querySelectorAll('#choices button').forEach(b=>b.disabled=true);
    showJudge(true);
    setTimeout(()=>{ idx++; next(); }, 420);
  } else {
    if(reviewEnabled) wrongSet.add(sym.id);
    disableWrongButton(btnEl);
    showJudge(false);
    if(!requireCorrect){
      // 正解不要モード：不正解でも次へ
      document.querySelectorAll('#choices button').forEach(b=>b.disabled=true);
      setTimeout(()=>{ idx++; next(); }, 500);
    }
    // 正解必須モードならここで止めて再挑戦
  }

  // ステータス更新
  $("#acc").textContent = attempts ? `${Math.round((correctClicks/attempts)*100)}%` : "0%";
}

// ===== クリア処理 =====
function finish(){
  const ms = performance.now()-startedAt;
  const acc = attempts? (correctClicks/attempts) : 0;
  const res = pushRankWithReturn(acc, ms);

  $("#finRank").textContent = `${res.rank}位`;
  const pct = Math.round(acc*100);
  $("#finAcc").textContent = `${pct}%`;
  $("#finTime").textContent = fmtTime(ms);
  $("#finGrade").textContent =
    (pct===100)?'👑 神':(pct>=80?'🦁 王者':(pct>=60?'🐴 人間':(pct>=50?'🐢 亀':'🐛 虫')));
  $("#finish").classList.add("show");
}

// ===== イベント =====
$("#restartBtn").addEventListener('click', ()=>{
  if(confirm('最初からやり直しますか？')){ $("#finish").classList.remove('show'); start(); }
});
$("#againBtn").addEventListener('click', ()=>{ $("#finish").classList.remove('show'); start(); });
$("#showRankBtn").addEventListener('click', ()=>{ $("#finish").classList.remove('show'); document.querySelector('#rank').open = true; });
$("#clearRankBtn").addEventListener('click', ()=>{
  if(confirm('ランキングを消去しますか？')){ localStorage.removeItem(LS_KEY); renderRank(); }
});
$("#preloadBtn").addEventListener('click', preloadImages);

// 設定モーダル
$("#settingsBtn").addEventListener('click', ()=> $("#settings").classList.add('show'));
$("#closeSettings").addEventListener('click', ()=> $("#settings").classList.remove('show'));
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') $("#settings").classList.remove('show'); });

// タイマー表示（1秒毎）
setInterval(()=>{ 
  const playing = !$("#finish").classList.contains('show');
  if(playing){ $("#time").textContent = fmtTime(performance.now()-startedAt); }
}, 1000);

// 起動
document.addEventListener("DOMContentLoaded", ()=>{
  renderRank(); preloadImages(); loadOpts(); start();
});
</script>
</body>
</html>
